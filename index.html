<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ç-A-Y Oyunu</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=VT323&display=swap" rel="stylesheet">
    <style>
        /* css değişkenleri (temalar) */
        :root{--bg:#f8f8f8;--text:#111;--score:#fff;--border:#ddd;--blue:#007bff;--green:#4caf50;--btn:#eee;--main-bg:#f8f8f8;--inv-bg:rgba(255,255,255,0.95);--red:#dc3545;--yellow:#ffc107}
        .dark{--bg:#000;--text:#fff;--score:rgba(255,255,255,.1);--border:#333;--blue:#0099ff;--green:#4caf50;--main-bg:#000;--inv-bg:rgba(0,0,0,0.9);--red:#ff4444;--yellow:#ffeb3b}
        .retro{--bg:#020b02;--text:#39ff14;--score:rgba(57, 255, 20, 0.1);--border:#1a7a0f;--blue:#39ff14;--green:#00c000;--main-bg:#000;--inv-bg:rgba(2,11,2,0.95);--red:#ff0000;--yellow:#ffff00}
        .retro h1,.retro h2,.retro .kupa-mesaji{text-shadow:0 0 5px var(--text), 0 0 10px var(--text)}
        .retro .scores,.retro .pot,.retro .status,.retro #history{border:2px solid var(--border);box-shadow:0 0 8px var(--text) inset}
        .retro .buttons button{font-family:'VT323', monospace; background:var(--bg); color:var(--text); border:1px solid var(--border); box-shadow:0 0 5px var(--text) !important}
        .retro .buttons button:hover{background:rgba(57, 255, 20, 0.2)}
        .retro .modal-content{border:2px solid var(--text); box-shadow:0 0 15px var(--text)}

        /* genel stiller */
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;margin:0;padding:10px;min-height:100vh;box-sizing:border-box;transition:.3s}
        
        /* Font Düzeltmesi: Başlıklar ve butonlar için Orbitron */
        h1, h2, #mainmenu h1, .buttons button, .modal-content h2 {
            font-family: 'Orbitron', sans-serif !important;
        }

        /* Retro temada skor ve geçmiş için VT323 */
        .retro #maxscoredisplay, .retro #history, .retro .scores, .retro .pot, .retro .status {
            font-family: 'VT323', monospace !important;
        }
        
        h1{margin:6px 0}
        #gamescreen{display:none;align-items:center;flex-direction:column;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;max-width:350px}
        .scores,.pot,.status{
            margin:6px 0;
            padding:8px;
            border-radius:10px;
            background:var(--score);
            border:1px solid var(--border);
            width:300px;
            text-align:center;
            box-sizing:border-box;
            transition:.3s;
        }
        .scores{display:flex;justify-content:space-around;padding:15px 8px}
        .player-score{text-align:center;font-size:18px;font-weight:700;line-height:1.2; position: relative; padding-top: 25px;} 
        .player-emoji{font-size:30px;margin-bottom:5px;display:block}
        
        /* Hamle Emojileri */
        .player-action-emoji {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%); font-size: 20px; opacity: 0; transition: opacity 0.3s ease-out, transform 0.3s ease-out; pointer-events: none;
        }
        .player-action-emoji.active {
            opacity: 1; transform: translateX(-50%) translateY(5px); 
        }

        /* POT ANİMASYONLARI (Opsiyonel ama estetik) */
        .pot-flash-green {background-color: var(--green) !important;color: white !important;box-shadow: 0 0 10px 5px var(--green);transform: scale(1.05);transition: all 0.1s ease-out;}
        .pot-flash-red {background-color: var(--red) !important;color: white !important;box-shadow: 0 0 10px 5px var(--red);transform: scale(1.05);transition: all 0.1s ease-out;}
        @keyframes pot-accumulate-flash {
            0%, 100% { background-color: var(--score);color: var(--text);box-shadow: none;transform: scale(1);}
            16.6%, 50%, 83.3% { background-color: var(--text); color: var(--bg);box-shadow: 0 0 10px 3px var(--text) inset;transform: scale(1.02);}
        }
        .pot-flash-accumulate {animation: pot-accumulate-flash 1.2s ease-in-out;}
        .retro .pot-flash-accumulate {animation: pot-accumulate-flash 1.2s ease-in-out 3;}

        /* RETRO TEMA İÇİN ANİMASYON DÜZELTMELERİ */
        .retro .pot-flash-green {
            background-color: var(--green) !important;
            color: var(--bg) !important;
            box-shadow: 0 0 10px 5px var(--green);
        }
        .retro .pot-flash-red {
            background-color: var(--red) !important;
            color: var(--bg) !important;
            box-shadow: 0 0 10px 5px var(--red);
        }

        .buttons{display:flex;justify-content:center}
        .buttons button{
            font-size:24px; font-weight:600; margin:5px; padding:10px 16px; border-radius:10px; border:1px solid #aaa; background:var(--btn); cursor:pointer; transition: transform 0.1s ease-out, background-color 0.1s; 
        }
        .buttons button:active { 
            transform: scale(0.9); background-color: var(--blue); color: white;
        }

        #history{width:300px;height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:5px;font-size:13px;text-align:left;background:var(--score);margin-top:12px}.kupa-mesaji{font-size:20px;font-weight:700;color:var(--green);margin-top:10px}
        .top-right-btns{position:fixed;top:5px;right:5px;left:5px;display:flex;justify-content:flex-end;width:auto;z-index:10}#settingsbtn{font-size:24px;background:none;border:none;cursor:pointer}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;z-index:20}
        .modal-content{position:relative;background:var(--score);color:var(--text);padding:20px;border-radius:10px;text-align:center;max-width:85%;width:350px;box-shadow:0 0 20px rgba(255,255,255,.5);transition:.3s}
        .modal-close-btn{position:absolute;top:10px;right:10px;font-size:20px;font-weight:700;color:var(--red);background:none;border:none;cursor:pointer;padding:0;line-height:1}
        .modal-action-btn{margin-top:15px;padding:8px 20px;background:var(--blue);color:#fff;border:none;border-radius:5px;display:block;width:80%;margin:10px auto;padding:10px}
        .tema-btn-group {display: flex; flex-wrap: wrap; justify-content: space-between;}
        .tema-btn-group button {width: 32%; margin: 5px 0.5%; padding: 10px; font-weight: bold; border: 2px solid var(--blue); background: none; color: var(--text); border-radius: 8px; cursor: pointer;}
        .tema-btn-group button.active {background: var(--blue); color: white;}
        
        /* ANA MENÜ GÜZELLEŞTİRME */
        #mainmenu{
            display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;position:fixed;top:0;left:0;width:100%;
            background: linear-gradient(145deg, var(--bg) 0%, var(--main-bg) 100%); 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            z-index:15;transition:.3s
        }
        #mainmenu h1{
            font-size: 50px; 
            color: var(--blue);
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-align: center; 
        }
        #mainmenu p{
            font-size: 18px;
            margin: 10px 0;
            font-weight: 500;
        }
        #lengthbuttons {
            display: flex;
            flex-direction: column; 
            width: 80%;
            max-width: 300px;
        }
        #lengthbuttons button {
            margin: 10px 0;
            padding: 15px 20px;
            font-size: 20px;
            border-radius: 10px;
            border: 3px solid var(--blue); 
            background: var(--btn);
            color: var(--text);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 var(--border);
        }
        #lengthbuttons button:hover {
            background: var(--blue);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
            transform: translateY(-2px);
        }
        
        /* --- ANA MENÜ BUTONLARI İÇİN TEMA DÜZELTMELERİ --- */
        .dark #lengthbuttons button {
            background: var(--text);   /* Beyaz Arka plan */
            color: var(--bg);          /* Siyah Metin */
            border-color: var(--blue);
            box-shadow: 0 4px 0 var(--border);
        }
        .retro #lengthbuttons button {
            background: var(--bg);     /* Koyu Yeşil Arka plan */
            color: var(--text);        /* Neon Yeşil Metin */
            border-color: var(--text);
            box-shadow: 0 4px 0 var(--border), 0 0 8px var(--text); 
        }
        .retro #lengthbuttons button:hover {
            background: rgba(57, 255, 20, 0.2);
            color: var(--text);
        }
        /* ------------------------------------------------ */
    
        /* hedef skor hud stilleri (Boyut ve Konum Güncellendi) */
        #maxscoredisplay {
            position: fixed;
            top: 60px; 
            left: 50%;
            transform: translateX(-50%); 
            font-family: 'Orbitron', sans-serif; 
            font-size: 60px; 
            font-weight: bold;
            color: var(--blue);
            text-shadow: 0 0 8px var(--text);
            z-index: 10;
            opacity: 0.9;
            display: none; 
            line-height: 1;
            padding: 0; 
            background: none; 
        }

        /* envanter & görev butonları */
        #inventorybtn, #missionbtn {position: fixed; bottom: 10px; font-size: 30px; background: var(--blue); color: white; border: 2px solid var(--border); border-radius: 50%; width: 50px; height: 50px; display: none; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 19; line-height: 1;}
        #inventorybtn { right: 10px; }
        #missionbtn { left: 10px; }

        /* görev butonu Üzerindeki tik */
        #missionbtn::after {content: attr(data-status-icon); position: absolute; top: -5px; right: -5px; font-size: 16px; background: var(--green); color: white; border-radius: 50%; padding: 2px 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); line-height: 1; display: none;}
        #missionbtn[data-status-icon="✅"]::after {display: block;}

        /* envanter modalı */
        #inventorymodal .modal-content {position: fixed; bottom: 0; left: 50%; transform: translate(-50%, 100%); width: 95%; max-width: 400px; background: var(--inv-bg); border-top: 3px solid var(--blue); border-radius: 15px 15px 0 0; box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: transform 0.4s ease-out; padding: 15px; color: var(--text); text-align: left; z-index: 19; }
        #inventorymodal.active .modal-content { transform: translate(-50%, 0); }
        #inventorycontainer {display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; min-height: 100px;}

        /* görev modalı */
        #missionmodal .modal-content {max-width: 95%; width: 400px;}
        .mission-info-box {padding: 15px; border: 2px solid var(--blue); border-radius: 10px; margin-bottom: 15px; background: var(--score); text-align: center;}
        
        /* drag-merge stilleri */
        .inventory-item {text-align: center; padding: 8px; border: 1px dashed var(--border); border-radius: 5px; background: var(--score); font-size: 14px; font-weight: 700; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: grab; transition: background-color 0.2s, box-shadow 0.2s; min-height: 80px;}
        .inventory-item:hover {box-shadow: 0 0 5px var(--blue);}
        .dragging {opacity: 0.4; border: 2px dashed var(--red);}
        .drop-target {box-shadow: 0 0 10px 3px var(--green) inset; border: 2px solid var(--green); transform: scale(1.05);}
    </style>
</head>
<body>

<div id="maxscoredisplay"></div> 
<div class="top-right-btns"><button id="settingsbtn" onclick="togglemodal('settingsmodal', true)">⚙️</button></div>

<div id="mainmenu">
    <h1 data-key="title">🫖 Ç-A-Y Oyunu</h1>
    <p data-key="select_length">Oyun uzunluğunu seçin:</p>
    <div id="lengthbuttons">
        <button onclick="startgame(15, 2)" data-key="len_short">Kısa (15 Puan) - 2 🪙</button>
        <button onclick="startgame(25, 4)" data-key="len_normal">Normal (25 Puan) - 4 🪙</button>
        <button onclick="startgame(35, 6)" data-key="len_long">Uzun (35 Puan) - 6 🪙</button>
    </div>
    <p data-key="browser_warning">Oyun Çalışmıyorsa Chrome ile Birlikte Açın.</p>
</div>

<div id="gamescreen">
    <div class="scores" id="scores"></div>
    <div class="pot" id="pot" data-key-prefix="pot_">Ortadaki Para: 6</div>
    <div class="status" id="status" data-key-prefix="status_">Hamleni Seç</div>
    <div class="buttons" id="actionbuttons">
        <button id="btnc" onclick="oyuncu('Ç')">Ç</button>
        <button id="btna" onclick="oyuncu('A')">A</button>
        <button id="btny" onclick="oyuncu('Y')">Y</button>
    </div>

    <p id="gameover"></p>
    <button id="newgamebtn" style="display:none;" onclick="resettomenu()" data-key="new_game_btn">Yeni Oyun</button>
    
    <div id="history"></div>
</div>

<button id="inventorybtn" onclick="toggleinventory(true)">🎒</button>
<button id="missionbtn" onclick="rendermissions()" data-status-icon="">📜</button>

<div id="inventorymodal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="toggleinventory(false)">x</button>
        <h2 style="text-align: center; color: var(--blue);" data-key="inventory_title_base">🎒 Envanter (Jeton: 0)</h2>
        <div id="inventorycontainer"></div>
    </div>
</div>

<div id="settingsmodal" class="modal">
    <div id="settingsmodalcontent" class="modal-content">
        <button class="modal-close-btn" onclick="togglemodal('settingsmodal', false)">x</button>
        <h2 data-key="settings_title">Ayarlar</h2>
        
        <h3 data-key="theme_selection_title">🎨 Tema Seçimi</h3>
        <div id="temasecim" class="tema-btn-group">
            <button id="beyaztemabtn" onclick="temasec('beyaz')" data-key="theme_white">⬜ Beyaz</button>
            <button id="siyahtemabtn" onclick="temasec('siyah')" data-key="theme_dark">🌑 Siyah</button>
            <button id="retrotemabtn" onclick="temasec('retro')" data-key="theme_retro">🖼️ Retro</button>
        </div>
        
        <button class="modal-action-btn" onclick="togglemodal('settingsmodal', false); togglemodal('promocodemodal', true)" data-key="promo_code_btn">🎁 Promosyon Kodu</button>
        <button class="modal-action-btn" onclick="togglemodal('settingsmodal', false); togglemodal('languagemodal', true)" data-key="language_btn">🗣️ Dil Seçimi</button>
        
        <button class="modal-action-btn" onclick="togglemodal('settingsmodal', false); togglemodal('howtoplaymodal', true)" data-key="how_to_play_btn">❓ Nasıl Oynanır</button>
        <button class="modal-action-btn" onclick="togglemodal('settingsmodal', false); togglemodal('creditsmodal', true)" data-key="credits_btn">⭐ Künye (Credits)</button>
    </div>
</div>

<div id="promocodemodal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="togglemodal('promocodemodal', false)">x</button>
        <h2 style="color: var(--blue);" data-key="promo_code_title">🎁 Promosyon Kodu</h2>
        <input type="text" id="promocodeinput" placeholder="Kodu Gir" style="width: 80%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid var(--border); box-sizing: border-box; font-size: 16px;">
        <button class="modal-action-btn" onclick="checkPromoCode()" style="background: var(--green); margin-top: 0;" data-key="use_code_btn">Kodu Kullan</button>
    </div>
</div>

<div id="languagemodal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="togglemodal('languagemodal', false)">x</button>
        <h2 style="color: var(--blue);" data-key="language_title">🗣️ Dil Seçimi</h2>
        <div class="tema-btn-group" id="dilsecimi">
            <button id="trdilbtn" class="active" onclick="changeLanguage('tr')">🇹🇷 Türkçe</button>
            <button id="endilbtn" onclick="changeLanguage('en')">🇬🇧 English</button>
        </div>
    </div>
</div>

<div id="missionmodal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="togglemodal('missionmodal', false)">x</button>
        <h2 style="color: var(--blue);" data-key="mission_title">📜 Aktif Görev</h2>
        <div id="missioncontainer">
            </div>
    </div>
</div>

<div id="howtoplaymodal" class="modal">
    <div id="howtoplaycontent" class="modal-content" style="text-align: left;">
        <button class="modal-close-btn" onclick="togglemodal('howtoplaymodal', false)">x</button>
        <h2 data-key="how_to_play_title">❓ Nasıl Oynanır</h2>
        <p data-key="how_to_play_text">Oyunun Adı Ç-A-Y, yani ÇAL, AL, YAKALA. 3 kişiyle oynanır. Herkes Ç, A, ya da Y yazar. Orta her tur 6 puan (para) üretir. Oyuncular bu parayı almaya çalışır. A(L) diyen parayı alır. Ç(AL) diyen alandan çalar. Y(AKALA) diyen çalanı yakalar (ve para ona geçer). Bir tur kimse AL demezse para birikir. Sırayla Ç-A-Y yazan oyuncu 4 puan kazanır.</p>
    </div>
</div>

<div id="creditsmodal" class="modal">
    <div id="creditscontent" class="modal-content">
        <button class="modal-close-btn" onclick="togglemodal('creditsmodal', false)">x</button>
        <h2 data-key="credits_title">Künye</h2>
        <p>NfShf Games</p>
        <p data-key="credits_devs">ChatGPT & Gemini</p>
    </div>
</div>

<script>
    // --- ÇEVİRİ VERİTABANI ---
    const translations = {
        tr: {
            title: '🫖 Ç-A-Y Oyunu',
            select_length: 'Oyun uzunluğunu seçin:',
            len_short: 'Kısa (15 Puan) - 2 🪙',
            len_normal: 'Normal (25 Puan) - 4 🪙',
            len_long: 'Uzun (35 Puan) - 6 🪙',
            browser_warning: 'Oyun Çalışmıyorsa Chrome ile Birlikte Açın.',
            
            pot_base: 'Ortadaki Para: ',
            status_choose: 'Hamleni Seç',
            status_countdown: (count) => `(${count})`,
            status_game_over: 'Oyun Bitti',
            
            new_game_btn: 'Yeni Oyun',
            
            inventory_title_base: '🎒 Envanter (Jeton: ',
            
            settings_title: 'Ayarlar',
            theme_selection_title: '🎨 Tema Seçimi',
            theme_white: '⬜ Beyaz',
            theme_dark: '🌑 Siyah',
            theme_retro: '🖼️ Retro',
            promo_code_btn: '🎁 Promosyon Kodu',
            language_btn: '🗣️ Dil Seçimi',
            how_to_play_btn: '❓ Nasıl Oynanır',
            credits_btn: '⭐ Künye (Credits)',
            
            promo_code_title: '🎁 Promosyon Kodu',
            use_code_btn: 'Kodu Kullan',
            
            language_title: '🗣️ Dil Seçimi',
            
            mission_title: '📜 Aktif Görev',
            
            how_to_play_title: '❓ Nasıl Oynanır',
            how_to_play_text: 'Oyunun Adı Ç-A-Y, yani ÇAL, AL, YAKALA. 3 kişiyle oynanır. Herkes Ç, A, ya da Y yazar. Orta her tur 6 puan (para) üretir. Oyuncular bu parayı almaya çalışır. A(L) diyen parayı alır. Ç(AL) diyen alandan çalar. Y(AKALA) diyen çalanı yakalar (ve para ona geçer). Bir tur kimse AL demezse para birikir. Sırayla Ç-A-Y yazan oyuncu 4 puan kazanır.',
            
            credits_title: 'Künye',
            credits_devs: 'ChatGPT & Gemini',
            
            // Dinamik Mesajlar
            msg_accumulated: 'Birikti.',
            msg_catchers_won: 'Yakalayanlar Kazandı.',
            msg_stolen: 'Para Çalındı.',
            msg_thieves_split: 'Çalanlar Bölüştü.',
            msg_takers_split: 'Alıcılar Bölüştü.',
            msg_bonus: '(+4 Bonus)!',
            msg_game_over_winner: (winner, reward) => `🏁 Oyun Bitti — Kazanan: ${winner}${reward > 0 ? ` (+${reward} Jeton)` : ""}`,
            msg_mission_complete: (mission_name) => `Görev Tamamlandı: ${mission_name} (Ödül Hazır!)`,
            msg_reward_collected: (reward) => `+${reward} Jeton Envantere Eklendi! Yeni Görev Atandı.`,
            msg_invalid_merge: 'Geçersiz Birleştirme.',
            msg_merge_count_needed: (name) => `Birleştirmek için 2 Adet ${name} Gerekiyor.`,
            msg_already_have_cup: (name) => `Zaten Bir Adet ${name} Mevcut.`,
            msg_merge_success: (name) => `🎉 Tebrikler! ${name} Elde Edildi!`,
            msg_code_used: (code) => `Kod (${code}) bu oturumda zaten kullanılmış.`,
            msg_enter_code: 'Lütfen bir kod girin.',
            msg_code_success_jeton: (reward) => `Başarılı! ${reward} Jeton kazandınız!`,
            msg_code_success_item: (reward, name, emoji) => `Başarılı! ${reward} adet ${name} (${emoji}) kazandınız!`,
            msg_code_invalid: 'Geçersiz veya süresi dolmuş kod.',
            msg_no_active_mission: 'Aktif Görev Yok. Yeni Oyun Başlatıldığında Atanacaktır.',
            msg_progress: (current, required) => `İlerleme: ${current} / ${required}`,
            msg_mission_ready: '✅ Görev Tamamlandı! Ödül toplamaya hazır.',
            msg_collect_reward: (reward) => `Ödülü Topla (${reward} 🪙)`,
            msg_cup_masterrozet: (name) => `🏅 ${name} Tamamlandı! Tebrikler! 🏅`,
            msg_cup_kiraathane: (name) => `😤 ${name} Tamamlandı! TEKRAR ET: BURASI KIRAATHANE Mİ LAN! 😤`,
        },
        en: {
            title: '🫖 C-A-Y Game',
            select_length: 'Select game length:',
            len_short: 'Short (15 Points) - 2 🪙',
            len_normal: 'Normal (25 Points) - 4 🪙',
            len_long: 'Long (35 Points) - 6 🪙',
            browser_warning: 'Open with Chrome if the game is not working.',
            
            pot_base: 'Money in Pot: ',
            status_choose: 'Choose Your Move',
            status_countdown: (count) => `(${count})`,
            status_game_over: 'Game Over',
            
            new_game_btn: 'New Game',
            
            inventory_title_base: '🎒 Inventory (Coin: ',
            
            settings_title: 'Settings',
            theme_selection_title: '🎨 Theme Selection',
            theme_white: '⬜ White',
            theme_dark: '🌑 Dark',
            theme_retro: '🖼️ Retro',
            promo_code_btn: '🎁 Promo Code',
            language_btn: '🗣️ Language Selection',
            how_to_play_btn: '❓ How to Play',
            credits_btn: '⭐ Credits',
            
            promo_code_title: '🎁 Promo Code',
            use_code_btn: 'Use Code',
            
            language_title: '🗣️ Language Selection',
            
            mission_title: '📜 Active Mission',
            
            how_to_play_title: '❓ How to Play',
            how_to_play_text: 'The game is called C-A-Y, which means Steal (Ç), Take (A), Catch (Y). It is played by 3 people. Everyone writes C, A, or Y. The center produces 6 points (money) every round. Players try to get this money. The one who says Take (A) gets the money. The one who says Steal (Ç) steals from the pot. The one who says Catch (Y) catches the thief (and the money goes to them). If no one says Take in a round, the money accumulates. The player who writes C-A-Y in sequence earns a 4 point bonus.',
            
            credits_title: 'Credits',
            credits_devs: 'Developed with ChatGPT & Gemini',
            
            // Dinamik Mesajlar
            msg_accumulated: 'Accumulated.',
            msg_catchers_won: 'Catchers Won.',
            msg_stolen: 'Money Stolen.',
            msg_thieves_split: 'Thieves Split.',
            msg_takers_split: 'Takers Split.',
            msg_bonus: '(+4 Bonus)!',
            msg_game_over_winner: (winner, reward) => `🏁 Game Over — Winner: ${winner}${reward > 0 ? ` (+${reward} Coins)` : ""}`,
            msg_mission_complete: (mission_name) => `Mission Completed: ${mission_name} (Reward Ready!)`,
            msg_reward_collected: (reward) => `+${reward} Coins Added to Inventory! New Mission Assigned.`,
            msg_invalid_merge: 'Invalid Merge.',
            msg_merge_count_needed: (name) => `2 ${name} Pieces Required for Merge.`,
            msg_already_have_cup: (name) => `You Already Have One ${name}.`,
            msg_merge_success: (name) => `🎉 Congratulations! ${name} Obtained!`,
            msg_code_used: (code) => `Code (${code}) already used in this session.`,
            msg_enter_code: 'Please enter a code.',
            msg_code_success_jeton: (reward) => `Success! You won ${reward} Coins!`,
            msg_code_success_item: (reward, name, emoji) => `Success! You won ${reward} pieces of ${name} (${emoji})!`,
            msg_code_invalid: 'Invalid or expired code.',
            msg_no_active_mission: 'No Active Mission. Will be Assigned when a New Game Starts.',
            msg_progress: (current, required) => `Progress: ${current} / ${required}`,
            msg_mission_ready: '✅ Mission Complete! Ready to collect reward.',
            msg_collect_reward: (reward) => `Collect Reward (${reward} 🪙)`,
            msg_cup_masterrozet: (name) => `🏅 ${name} Completed! Congratulations! 🏅`,
            msg_cup_kiraathane: (name) => `😤 ${name} Completed! REPEAT: IS THIS A COFFEEHOUSE, HUH! 😤`,
        }
    };

    // sabitler ve global değişkenler
    const adlar = ['sen', 'yz1', 'yz2']; 
    const user_emoji = '🧑'; 
    const dyn_emo = ['🤖', '👽', '☻️', '👶', '😺', '🥸'];
    const birlestirme_parca_sayisi = 2;
    const mission_reward = 3; 
    
    // Promosyon Kodları Eklendi ve Güncellendi
    const promoCodes = {
        'CAYYENIDEN': { reward: 10, type: 'jeton', used: false },
        'GEMINI5': { reward: 5, type: 'jeton', used: false },
        'MASTERAY': { reward: 2, type: 'jeton', used: false }, 
        'PROMO2025': { reward: 3, type: 'jeton', used: false },
        'SUDOHACKSYSTEM': { reward: 32, type: 'jeton', used: false }, // 32 Jeton
        'SUAYIPSISMAN': { reward: 2, type: 'item', item_id: 'tarihkitabi', used: false }, // 2 Tarih Kitabı
    };
    let usedPromoCodes = []; 
    
    // Dil değişkeni
    let currentLanguage = 'tr'; 
    
    // Hamle Emojileri için sabitler
    const move_emojis = {
        'Ç': '💰', 
        'A': '🫳', 
        'Y': '👨‍✈️' 
    };

    // envanter ve görev yapıları (Yeni Öğeler Eklendi)
    const items_default = { 
        jeton: { name: 'Jeton', emoji: '🪙', list: [] },
        garnetparca: { name: 'Garnet Parça', emoji: '💠', list: [] },
        garnetkupa: { name: 'Garnet Kupa', emoji: '🏆', list: [] },
        serpantinparca: { name: 'Serpantin Parça', emoji: '🐍', list: [] },
        serpantinkupa: { name: 'Serpantin Kupa', emoji: '👑', list: [] },
        tarihkitabi: { name: 'Tarih Kitabı', emoji: '📚', list: [] }, // Yeni Öğe
        kiraathanemilan: { name: 'Burası Kıraathane mi Lan', emoji: '😤', list: [] }, // Yeni Öğe (Kupa)
        masterrozet: { name: 'Çayların Efendisi Rozeti', emoji: '🏅', list: [] }
    };
    let items = JSON.parse(JSON.stringify(items_default)); 

    
    const missions = {
        'bonus_cay_x2': { name: 'Bir oyunda iki kez ÇAY yaz', progress: 0, required: 2, name_en: 'Write ÇAY twice in one game' },
        'no_c_game': { name: 'Bir oyunu Ç demeden kazan', progress: false, required: true, name_en: 'Win a game without saying Ç (Steal)' },
        'defeat_smiley': { name: '☻️ karakterini bir kez yen', progress: false, required: true, name_en: 'Defeat the ☻️ character once' },
        'cacaça': { name: 'ÇAÇAÇA yaz', progress: 0, required: 1, name_en: 'Write ÇAÇAÇA' }, 
        'big_win': { name: 'En az 15 puanı tek hamlede kazan', progress: false, required: true, name_en: 'Win at least 15 points in a single move' }
    };
    
    // değişkenlerin varsayılan değerleri (sıfırlama için kullanılır)
    const default_state = {
        p: [0, 0, 0], pot: 6, aktiftema: 'beyaz', bitis: false, 
        hamleler: [[], [], []], cooldown: false, max_skor: 30, 
        kazanc_jeton: 5, nextuniqueid: 1, draggediteminfo: null, 
        activemissionkey: null, activemissioncompleted: false, 
        previousmissionkey: null, cemo: [user_emoji, '', '']
    };

    let p = default_state.p.slice(); 
    let pot = default_state.pot; 
    let aktiftema = default_state.aktiftema; 
    let bitis = default_state.bitis; 
    let hamleler = default_state.hamleler.map(arr => arr.slice()); 
    let cooldown = default_state.cooldown; 
    let d = {}; 
    let max_skor = default_state.max_skor; 
    let kazanc_jeton = default_state.kazanc_jeton; 
    let nextuniqueid = default_state.nextuniqueid; 
    let draggediteminfo = default_state.draggediteminfo; 
    let activemissionkey = default_state.activemissionkey;
    let activemissioncompleted = default_state.activemissioncompleted;
    let previousmissionkey = default_state.previousmissionkey;
    let cemo = default_state.cemo.slice(); 

    let last_moves_emojis = ['', '', '']; 

    // --- başlangıç fonksiyonları ---
    window.onload = function() {
        ['mainmenu', 'gamescreen', 'scores', 'pot', 'status', 'gameover', 'newgamebtn', 'history', 'settingsmodalcontent', 'temasecim', 'inventorybtn', 'missionbtn', 'inventorymodal', 'inventorycontainer', 'missionmodal', 'missioncontainer', 'maxscoredisplay', 'dilsecimi', 'promocodemodal', 'languagemodal'].forEach(id => d[id] = document.getElementById(id)); 
        d.btns = [document.getElementById('btnc'), document.getElementById('btna'), document.getElementById('btny')];

        setupNewGameEmojis(); 
        assignRandomMission(); 
        
        temasec('beyaz', true);
        changeLanguage('tr'); // Başlangıç dilini Türkçe ayarla ve arayüzü güncelle
        guncelle(); 
    };
    
    // YARDIMCI ÇEVİRİ FONKSİYONU
    function T(key, ...args) {
        const langPack = translations[currentLanguage];
        if (langPack && langPack[key]) {
            const value = langPack[key];
            return typeof value === 'function' ? value(...args) : value;
        }
        // Eğer çeviri yoksa (ya da sadece Türkçe tanım varsa), Türkçe karşılığını döndür
        return translations['tr'][key] || `[${key}]`; 
    }
    
    // ARAYÜZ METİNLERİNİ DİLE GÖRE GÜNCELLEYEN FONKSİYON
    function updateUIForLanguage() {
        // Data-key attribut'ü olan elementleri güncelle
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            el.innerText = T(key);
        });
        
        // Dinamik olarak oluşturulan metinleri güncelle
        document.getElementById('pot').innerText = T('pot_base') + Math.floor(pot);
        document.getElementById('status').innerText = T('status_choose');
        document.getElementById('promocodeinput').placeholder = currentLanguage === 'tr' ? 'Kodu Gir' : 'Enter Code';
        
        // Menü butonlarını (puan limitli) güncelle
        document.querySelector('[onclick="startgame(15, 2)"]').innerText = T('len_short');
        document.querySelector('[onclick="startgame(25, 4)"]').innerText = T('len_normal');
        document.querySelector('[onclick="startgame(35, 6)"]').innerText = T('len_long');
        
        // Envanter başlığını güncelle
        if (d.inventorymodal.querySelector('h2')) {
            d.inventorymodal.querySelector('h2').innerHTML = T('inventory_title_base') + items.jeton.list.length + (currentLanguage === 'en' ? ')' : ')');
        }
        
        // Dil seçimi butonlarının aktifliğini ayarla
        document.querySelectorAll('#dilsecimi button').forEach(btn => btn.classList.remove('active'));
        if(document.getElementById(`${currentLanguage}dilbtn`)) {
            document.getElementById(`${currentLanguage}dilbtn`).classList.add('active');
        }
    }

    function uyar(msg) { alert(msg) }
    function rasgele() { return ['A', 'Ç', 'Y'][Math.floor(Math.random() * 3)] }
    function setupNewGameEmojis() { 
        const shuffled = dyn_emo.sort(() => .5 - Math.random()); 
        cemo[1] = shuffled[0]; 
        cemo[2] = shuffled[1];
    }
    
    // PROMOSYON KODU KONTROL FONKSİYONU - Case Insensitive (Büyük/Küçük Harf Duyarsız)
    function checkPromoCode() {
        const input = document.getElementById('promocodeinput');
        const code = input.value.toUpperCase().trim(); 
        const codeData = promoCodes[code];

        if (!code) {
            return uyar(T('msg_enter_code'));
        }
        
        if (usedPromoCodes.includes(code)) {
            return uyar(T('msg_code_used', code));
        }

        if (codeData) {
            if (codeData.type === 'jeton') {
                for (let i = 0; i < codeData.reward; i++) {
                    items.jeton.list.push({ uniqueid: nextuniqueid++ });
                }
                uyar(T('msg_code_success_jeton', codeData.reward));
            } else if (codeData.type === 'item') {
                const itemType = items[codeData.item_id];
                for (let i = 0; i < codeData.reward; i++) {
                    itemType.list.push({ uniqueid: nextuniqueid++ });
                }
                uyar(T('msg_code_success_item', codeData.reward, itemType.name, itemType.emoji));
            }
            
            usedPromoCodes.push(code);
            codeData.used = true;
            input.value = '';
            guncelle(); 
        } else {
            uyar(T('msg_code_invalid'));
        }
    }
    
    // DİL DEĞİŞTİRME FONKSİYONU
    function changeLanguage(lang) {
        if (currentLanguage !== lang) {
            currentLanguage = lang;
            updateUIForLanguage();
            guncelle();
        }
    }
    
    function togglemodal(id, ac) { 
        const modal = document.getElementById(id); 
        modal.style.display = ac ? 'flex' : 'none'; 
        if (ac) guncelle();
        else {
            if (id !== 'inventorymodal') restorePlayerActionEmojis();
        }
    }

    function toggleinventory(ac) {
        if (ac) { 
            d.inventorymodal.querySelector('h2').innerHTML = T('inventory_title_base') + items.jeton.list.length + (currentLanguage === 'en' ? ')' : ')');
            renderInventory(); 
            d.inventorymodal.classList.add('active'); 
            d.inventorymodal.style.display = 'flex'; 
        } 
        else { 
            d.inventorymodal.classList.remove('active'); 
            setTimeout(() => { d.inventorymodal.style.display = 'none'; }, 400); 
            restorePlayerActionEmojis(); 
        }
    }

    function resetCurrentGameState() {
        p = default_state.p.slice(); 
        pot = default_state.pot; 
        bitis = false; 
        hamleler = default_state.hamleler.map(arr => arr.slice()); 
        cooldown = false; 
        setupNewGameEmojis(); 
        
        resetMissionProgress(activemissionkey);
        
        d.history.innerHTML = ""; 
        d.gameover.innerText = ""; 
        d.newgamebtn.style.display = "none"; 
        d.btns.forEach(btn => btn.disabled = false); 
        d.status.innerText = T('status_choose');
        clearPlayerActionEmojis(); 
        last_moves_emojis = ['', '', '']; 
    }

    function resettomenu() {
        resetCurrentGameState();
        
        d.gamescreen.style.display = 'none'; 
        d.inventorybtn.style.display = 'none'; 
        d.missionbtn.style.display = 'none'; 
        d.maxscoredisplay.style.display = 'none'; 
        d.mainmenu.style.display = 'flex'; 
        
        updateUIForLanguage();
        guncelle();
    }

    function startgame(score_limit, coin_reward) {
        max_skor = score_limit; 
        kazanc_jeton = coin_reward;
        
        resetCurrentGameState();
        
        d.mainmenu.style.display = 'none'; 
        d.gamescreen.style.display = 'flex'; 
        d.inventorybtn.style.display = 'flex'; 
        d.missionbtn.style.display = 'flex'; 
        d.maxscoredisplay.style.display = 'block'; 
        d.maxscoredisplay.innerText = `${max_skor}`; 
        
        guncelle()
    }

    // --- oyun mantığı ---

    function oyuncu(h) {
        if (bitis || cooldown) return; 
        cooldown = true; 
        d.btns.forEach(btn => btn.disabled = true);
        
        clearPlayerActionEmojis(); 

        const mv = [h, rasgele(), rasgele()]; 
        tursonucu(mv);
        let sayac = 3; 
        d.status.innerText = T('status_countdown', sayac);
        const interval = setInterval(() => {
            sayac--;
            if (sayac > 0) { d.status.innerText = T('status_countdown', sayac); }
            else { 
                clearInterval(interval); 
                cooldown = false; 
                d.btns.forEach(btn => btn.disabled = bitis); 
                d.status.innerText = bitis ? T('status_game_over') : T('status_choose');
            }
        }, 1000)
    }

    function tursonucu(mv) {
        const onceki = pot; 
        const a = mv.filter(x => x === 'A').length; 
        const c = mv.filter(x => x === 'Ç').length; 
        const y = mv.filter(x => x === 'Y').length;
        let kazanc = [0, 0, 0]; 
        let paylasildi = false; 
        let aciklama = [];
        
        let animationClass = '';
        let duration = 300; 

        if (a === 0) { 
            // Para Birikti
            animationClass = 'pot-flash-accumulate'; 
            duration = 1200; 
            aciklama.push(T('msg_accumulated')); 
            pot += 6;
        }
        else if (c > 0 && y > 0) { 
            const pay = onceki / y; mv.forEach((m, i) => { if (m === 'Y') kazanc[i] = pay }); 
            paylasildi = true; aciklama.push(T('msg_catchers_won')); 
        }
        else if (c > 0) { 
            const calanlar = mv.map((m, i) => m === 'Ç' ? i : -1).filter(i => i !== -1); 
            const pay = onceki / c; calanlar.forEach(i => kazanc[i] = pay); 
            paylasildi = true; aciklama.push(calanlar.length === 1 ? T('msg_stolen') : T('msg_thieves_split')); 
        }
        else if (a > 0) { 
            const pay = onceki / a; mv.forEach((m, i) => { if (m === 'A') kazanc[i] = pay }); 
            paylasildi = true; aciklama.push(T('msg_takers_split')); 
        }

        if (paylasildi) { 
            for (let i = 0; i < 3; i++) p[i] += kazanc[i]; 
            pot = 6;
            
            if (kazanc[0] > 0) {
                animationClass = 'pot-flash-green'; // User won
            } else {
                animationClass = 'pot-flash-red'; // User lost, but pot was distributed
            }
        } 
        
        // Animasyonu Uygula ve Kaldır
        if (animationClass) {
            d.pot.classList.add(animationClass);
            setTimeout(() => {
                d.pot.classList.remove(animationClass);
            }, duration);
        }

        let bonusaciklama = ""; 
        let usercaybonus = false; 
        
        for (let i = 0; i < 3; i++) { 
            hamleler[i].push(mv[i]); 
            if (hamleler[i].slice(-3).join('') === 'ÇAY') { 
                p[i] += 4; bonusaciklama += ` ${cemo[i]} ${T('msg_bonus')}`;
                if (i === 0) usercaybonus = true; 
            }
        }
        
        // Görev İlerlemesi Kontrolü
        if (!activemissioncompleted && activemissionkey) {
            const m = missions[activemissionkey];
            
            if (activemissionkey === 'bonus_cay_x2' && usercaybonus) {
                if (typeof m.progress === 'number') m.progress++;
            }
            else if (activemissionkey === 'cacaça' && hamleler[0].length >= 6 && hamleler[0].slice(-6).join('') === 'ÇAÇAÇA') {
                m.progress = m.required;
            }
            else if (activemissionkey === 'big_win' && kazanc[0] >= 15) {
                m.progress = true;
            }
            
            checkMissionComplete();
        }

        const kazancstr = kazanc.map(x => Math.floor(x)).join(', ');
        const s = `${cemo[0]}:${mv[0]} | ${cemo[1]}:${mv[1]} | ${cemo[2]}:${mv[2]} → +${kazancstr} | ${aciklama.join(' ')}${bonusaciklama}`;

        d.history.innerHTML += s + "<br>"; d.history.scrollTop = d.history.scrollHeight;
        
        guncelle(); 
        kontrol();

        mv.forEach((move, i) => {
            const move_emoji = move_emojis[move];
            last_moves_emojis[i] = move_emoji; 
            const playerActionEmojiSpan = document.getElementById(`player-action-emoji-${i}`);
            if (playerActionEmojiSpan) {
                playerActionEmojiSpan.innerText = move_emoji;
                playerActionEmojiSpan.classList.add('active');
            }
        });
    }
    
    function clearPlayerActionEmojis() {
        document.querySelectorAll('.player-action-emoji').forEach(span => {
            span.classList.remove('active');
            span.innerText = '';
        });
    }

    function restorePlayerActionEmojis() {
        if (!last_moves_emojis[0]) return; 
        
        last_moves_emojis.forEach((emoji, i) => {
            if (emoji) {
                const playerActionEmojiSpan = document.getElementById(`player-action-emoji-${i}`);
                if (playerActionEmojiSpan) {
                    playerActionEmojiSpan.innerText = emoji;
                    playerActionEmojiSpan.classList.add('active');
                }
            }
        });
    }

    function kontrol() {
        if (bitis) return; const mx = Math.max(...p);
        
        if (!activemissioncompleted && activemissionkey) {
            const m = missions[activemissionkey];
            
            if (activemissionkey === 'defeat_smiley' && (cemo[1] === '☻️' || cemo[2] === '☻️')) {
                const smileyindex = cemo.indexOf('☻️');
                if (p[0] >= max_skor && Math.floor(p[smileyindex]) < max_skor) m.progress = true; 
            }
            
            if (activemissionkey === 'no_c_game' && p[0] >= max_skor) {
                const otherwinners = p.slice(1).some(score => Math.floor(score) >= max_skor);
                if (!otherwinners && !hamleler[0].includes('Ç')) {
                    m.progress = true; 
                }
            }
            
            checkMissionComplete();
        }

        if (mx >= max_skor) {
            bitis = true; d.btns.forEach(btn => btn.disabled = true);
            
            let final_reward = 0;
            if (p[0] >= max_skor) { 
                final_reward = kazanc_jeton;
                for(let i=0; i<kazanc_jeton; i++) items.jeton.list.push({ uniqueid: nextuniqueid++ });
            }
            
            const kazananlar = p.map((p, i) => Math.floor(p) >= max_skor ? adlar[i] : null).filter(Boolean).join(', ');
            
            // Çeviriyi kullan
            d.gameover.innerText = T('msg_game_over_winner', kazananlar, final_reward);
            
            d.newgamebtn.style.display = "inline-block"; d.status.innerText = T('status_game_over');
        }
    }

    // --- görev mantığı --- 
    function assignRandomMission() {
        const missionkeys = Object.keys(missions);
        let newmissionkey;
        let attempts = 0;
        
        do {
            const randomindex = Math.floor(Math.random() * missionkeys.length);
            newmissionkey = missionkeys[randomindex];
            attempts++;
            if (attempts > 10) break; 
        } while (newmissionkey === activemissionkey); 

        previousmissionkey = activemissionkey; 
        activemissionkey = newmissionkey;
        activemissioncompleted = false; 
        d.missionbtn.setAttribute('data-status-icon', ''); 
        guncelle(); 
    }
    
    function collectRewardAndAssignNew() {
        if (!activemissioncompleted) return;

        for(let i=0; i<mission_reward; i++) items.jeton.list.push({ uniqueid: nextuniqueid++ });

        d.gameover.innerText = ""; d.gameover.className = "";
        
        resetMissionProgress(activemissionkey); 
        assignRandomMission(); 
        
        togglemodal('missionmodal', false);
        
        uyar(T('msg_reward_collected', mission_reward));
        guncelle(); 
    }

    function resetMissionProgress(key) {
        if (!key) return;
        
        missions['bonus_cay_x2'].progress = 0;
        missions['no_c_game'].progress = false;
        missions['defeat_smiley'].progress = false;
        missions['cacaça'].progress = 0;
        missions['big_win'].progress = false;
        
        const mission = missions[key];
        if (typeof mission.progress === 'number') {
            mission.progress = 0;
        } else {
            mission.progress = false;
        }
        activemissioncompleted = false; 
        d.missionbtn.setAttribute('data-status-icon', ''); 
    }
    
    function checkMissionComplete() {
        if (activemissioncompleted || !activemissionkey) return;
        
        const mission = missions[activemissionkey];
        let completed = false;
        
        if (typeof mission.progress === 'number' && mission.progress >= mission.required) completed = true;
        else if (typeof mission.progress === 'boolean' && mission.progress === true) completed = true;
        
        if (completed) {
            activemissioncompleted = true; 
            d.missionbtn.setAttribute('data-status-icon', '✅');
            
            const missionName = currentLanguage === 'en' ? mission.name_en : mission.name;
            d.gameover.innerText = T('msg_mission_complete', missionName);
            
            d.gameover.className = "kupa-mesaji";
            guncelle(); 
        }
    }

    function rendermissions() {
        const container = d.missioncontainer;
        
        if (!activemissionkey) {
             container.innerHTML = `<div class="mission-info-box"><strong>${T('msg_no_active_mission')}</strong></div>`;
            togglemodal('missionmodal', true);
            return;
        }

        const mission = missions[activemissionkey];
        const missionName = currentLanguage === 'en' ? mission.name_en : mission.name;
        
        let progressinfo = '';
        if (typeof mission.progress === 'number') {
             progressinfo = `<p style="font-weight: bold; color: var(--blue); margin-top: 10px;">${T('msg_progress', mission.progress, mission.required)}</p>`;
        }
        
        let buttonhtml = '';
        let statusMessage = '';
        if (activemissioncompleted) {
            buttonhtml = `<button class="modal-action-btn" style="background:var(--green);" onclick="collectRewardAndAssignNew()">${T('msg_collect_reward', mission_reward)}</button>`;
            statusMessage = `<p style="font-weight: bold; color: var(--green); margin-bottom: 15px;">${T('msg_mission_ready')}</p>`;
        } 
        
        container.innerHTML = `
            <div class="mission-info-box">
                <h3 style="color: var(--text); margin-bottom: 5px;">${missionName}</h3>
                ${progressinfo}
            </div>
            ${statusMessage}
            ${buttonhtml}
        `;
        
        togglemodal('missionmodal', true); 
    }

    // --- envanter ve birleştirme mantığı --- 
    function renderInventory() {
        d.inventorycontainer.innerHTML = '';
        
        Object.keys(items).forEach(itemid => {
            const item = items[itemid];
            
            const itemName = currentLanguage === 'en' ? (item.name_en || item.name) : item.name;

            if ((itemid === 'masterrozet' || itemid === 'kiraathanemilan') && item.list.length > 0) {
                if (!item.list[0].notified) {
                    item.list[0].notified = true;
                    if(itemid === 'masterrozet') d.gameover.innerText = T('msg_cup_masterrozet', itemName);
                    else d.gameover.innerText = T('msg_cup_kiraathane', itemName);
                    d.gameover.className = "kupa-mesaji"; 
                    setTimeout(() => { d.gameover.innerText = ""; d.gameover.className = ""; }, 5000);
                }
            }

            item.list.forEach(uniqueitem => {
                const div = document.createElement('div');
                div.className = 'inventory-item'; div.id = `${itemid}-${uniqueitem.uniqueid}`;
                div.setAttribute('data-item', itemid); div.setAttribute('data-unique-id', uniqueitem.uniqueid); 
                const candrag = itemid !== 'masterrozet' && itemid !== 'kiraathanemilan'; div.setAttribute('data-can-drag', candrag ? 'true' : 'false'); div.draggable = candrag;

                if (candrag) {
                    ['dragstart', 'dragover', 'dragleave', 'drop', 'dragend'].forEach(e => div.addEventListener(e, eval(e)));
                }

                div.innerHTML = `<span>${item.emoji}</span>${itemName}`;
                d.inventorycontainer.appendChild(div);
            });
        });
    }

    function dragstart(e) {
        const itemid = e.target.getAttribute('data-item'); const uniqueid = e.target.getAttribute('data-unique-id');
        if (e.target.getAttribute('data-can-drag') === 'true') {
            draggediteminfo = { itemid, uniqueid: parseInt(uniqueid) };
            const jsonData = JSON.stringify(draggediteminfo);
            e.dataTransfer.setData('text/plain', jsonData); e.dataTransfer.setData('application/json', jsonData);
            e.target.classList.add('dragging');
        } else { e.preventDefault(); }
    }
    function dragover(e) {
        e.preventDefault();
        const targetElement = e.currentTarget; const targetid = targetElement.getAttribute('data-item'); const targetuniqueid = parseInt(targetElement.getAttribute('data-unique-id'));
        if (!draggediteminfo) return;
        const cannotMergeTo = ['masterrozet', 'kiraathanemilan']; // Kupa öğelerine birleştirme yapılmasını engeller
        if (draggediteminfo.itemid === targetid && draggediteminfo.uniqueid !== targetuniqueid && !cannotMergeTo.includes(targetid)) targetElement.classList.add('drop-target');
        else targetElement.classList.remove('drop-target');
    }
    function dragleave(e) { e.currentTarget.classList.remove('drop-target'); }
    function drop(e) {
        e.preventDefault(); e.currentTarget.classList.remove('drop-target');
        let data = e.dataTransfer.getData('application/json') || e.dataTransfer.getData('text/plain'); if (!data) return; 
        let sourceinfo; try { sourceinfo = JSON.parse(data); } catch (error) { return; }
        const targetElement = e.currentTarget; const targetid = targetElement.getAttribute('data-item'); const targetuniqueid = parseInt(targetElement.getAttribute('data-unique-id'));

        if (sourceinfo.itemid !== targetid || sourceinfo.uniqueid === targetuniqueid) { return uyar(T('msg_invalid_merge')); }
        
        handleMerge(sourceinfo.itemid, sourceinfo.uniqueid, targetuniqueid);
    }
    function dragend(e) { e.target.classList.remove('dragging'); draggediteminfo = null; }

    function handleMerge(sourceid, id1, id2) {
        const sourcelist = items[sourceid].list;
        const sourceItemName = currentLanguage === 'en' ? (items[sourceid].name_en || items[sourceid].name) : items[sourceid].name;
        
        const itemsToMerge = sourcelist.filter(p => p.uniqueid === id1 || p.uniqueid === id2);
        if (itemsToMerge.length < birlestirme_parca_sayisi) { return uyar(T('msg_merge_count_needed', sourceItemName)); }

        const mergemap = { 
            'jeton': 'garnetparca', 
            'garnetparca': 'garnetkupa', 
            'garnetkupa': 'serpantinparca', 
            'serpantinparca': 'serpantinkupa', 
            'serpantinkupa': 'masterrozet',
            'tarihkitabi': 'kiraathanemilan' // Yeni birleştirme kuralı
        };
        
        const resultid = mergemap[sourceid];
        const resultItem = items[resultid];
        const resultName = currentLanguage === 'en' ? (resultItem.name_en || resultItem.name) : resultItem.name;
        
        // Master Rozet ve Kiraathane'nin sadece bir tane olması kontrolü
        if (!resultid || (resultid === 'masterrozet' && resultItem.list.length > 0) || (resultid === 'kiraathanemilan' && resultItem.list.length > 0)) {
            return uyar(resultid ? T('msg_already_have_cup', resultName) : T('msg_invalid_merge'));
        }
        
        items[sourceid].list = sourcelist.filter(p => p.uniqueid !== id1 && p.uniqueid !== id2);
        
        const new_item_object = { uniqueid: nextuniqueid++ };
        if(resultid === 'masterrozet' || resultid === 'kiraathanemilan') new_item_object.notified = false; 

        resultItem.list.push(new_item_object);

        d.gameover.innerText = T('msg_merge_success', resultName); d.gameover.className = "kupa-mesaji";

        if (resultid === 'masterrozet' || resultid === 'kiraathanemilan') { 
            // Kiraathane itemi kazanıldığında özel bildirim.
            if(resultid === 'kiraathanemilan') {
                d.gameover.innerText = T('msg_cup_kiraathane', resultName);
            }
            // Rozet/Kupa kazanımı sonrası bildirim
            setTimeout(() => { d.gameover.innerText = ""; d.gameover.className = ""; if(!bitis) d.status.innerText = T('status_choose'); }, 5000); 
        } 
        else { setTimeout(() => { d.gameover.innerText = ""; d.gameover.className = ""; if(!bitis) d.status.innerText = T('status_choose'); }, 5000); }

        guncelle(); 
    }

    // **************** gÜncelleme ve tema ******************
    function guncelle() {
        d.scores.innerHTML = p.map((p, i) => 
            `<div class="player-score">
                <span class="player-action-emoji" id="player-action-emoji-${i}"></span>
                <span class="player-emoji">${cemo[i]}</span>
                ${Math.floor(p)}
            </div>`
        ).join('');
        d.pot.innerText = T('pot_base') + Math.floor(pot); 
        
        if (d.inventorymodal.querySelector('h2')) {
            d.inventorymodal.querySelector('h2').innerHTML = T('inventory_title_base') + items.jeton.list.length + (currentLanguage === 'en' ? ')' : ')');
        }
        
        if(d.maxscoredisplay.style.display === 'block') d.maxscoredisplay.innerText = `${max_skor}`;
        
        renderInventory();
        temasec(aktiftema, true);
        
        restorePlayerActionEmojis(); 
        
        // Dil seçimi butonunu aktif dile göre ayarla
        document.querySelectorAll('#dilsecimi button').forEach(btn => btn.classList.remove('active'));
        if(document.getElementById(`${currentLanguage}dilbtn`)) {
            document.getElementById(`${currentLanguage}dilbtn`).classList.add('active');
        }
    }
    
    function temasec(tema, initial = false) {
        aktiftema = tema;
        document.body.classList.remove('dark', 'retro');
        if (tema === 'siyah') document.body.classList.add('dark');
        else if (tema === 'retro') document.body.classList.add('retro');

        if (!initial) {
            guncelle();
        }

        document.querySelectorAll('#temasecim button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${tema}temabtn`).classList.add('active');
    }
</script>
</body>
</html>