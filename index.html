<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√á-A-Y Oyunu</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=VT323&family=Space+Mono&display=swap" rel="stylesheet">
    <style>
        /* --- Temel Deƒüi≈ükenler --- */
        :root{--bg:#f8f4f8;--text:#111;--score:#fff;--border:#ddd;--blue:#007bff;--green:#4caf50;--btn:#eee;--red:#dc3545; --text-rgb: 17, 17, 17; --blue-rgb: 0, 123, 255;}
        /* Sƒ∞YAH TEMA G√úNCELLENDƒ∞ */
        .dark{--bg:#000;--text:#fff;--score:rgba(255,255,255,.1);--border:#333;--blue:#0099ff;--red:#ff4444; --text-rgb: 255, 255, 255; --blue-rgb: 0, 153, 255; --btn:#1a1a1a;} /* Buton arka planƒ± siyah temaya uygun ayarlandƒ± */
        
        /* --- Genel Stiller --- */
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;margin:0;padding:10px;min-height:100vh;}
        h1, h2, .buttons button, .modal-content h2 {font-family: 'Orbitron', sans-serif !important;}
        #gamescreen{display:flex;align-items:center;flex-direction:column;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;max-width:350px;}
        .scores,.pot{margin:4px 0; padding:8px;border-radius:10px;background:var(--score);border:1px solid var(--border);width:300px;text-align:center;box-sizing:border-box;}
        #pot {display: flex; flex-direction: column; align-items: center; font-size: 20px; padding: 5px 8px;}
        .coin-row {white-space: nowrap;}
        .scores{display:flex;justify-content:space-around;padding:15px 8px}
        .player-score{position: relative; padding-top: 25px; text-align:center;font-size:18px;font-weight:700;} 
        .player-emoji{font-size:30px;margin-bottom:5px;display:block}
        .player-action-emoji {position: absolute; top: 0; left: 50%; transform: translateX(-50%); font-size: 20px; opacity: 0; transition: opacity 0.3s, transform 0.3s; pointer-events: none;}
        .player-action-emoji.active {opacity: 1; transform: translateX(-50%) translateY(5px);}
        .pot-flash-green {background-color: var(--green) !important; color: white !important; box-shadow: 0 0 10px 5px var(--green); transform: scale(1.05); transition: all 0.1s;}
        @keyframes pot-accumulate-flash {0%, 100% { background-color: var(--score); } 50% { background-color: var(--text); color: var(--bg);}}
        .pot-flash-accumulate {animation: pot-accumulate-flash 1.2s ease-in-out;}
        .buttons{display:flex;justify-content:center}
        /* Siyah temada buton yazƒ± rengi beyaz olsun */
        .buttons button{font-size:28px; font-weight:600; margin:5px; padding:10px 16px; border-radius:10px; border:1px solid #aaa; background:var(--btn); cursor:pointer; position: relative; overflow: hidden; transition: transform 0.1s; color: var(--text);}
        .dark .buttons button {color: white;} /* Siyah temada buton yazƒ±sƒ± beyaz */
        .buttons button:active { transform: scale(0.9); background-color: var(--blue); color: white;}
        .buttons button.cooldown {background-color: #ccc !important; color: var(--text) !important; pointer-events: none; opacity: 0.7;}
        /* Siyah temada cooldown butonu rengi */
        .dark .buttons button.cooldown {background-color: #333 !important; color: #999 !important;}
        #history{width:300px;height:100px; overflow-y:auto;border:2px solid var(--border); border-radius:10px; padding:10px;font-size:24px; line-height: 1.2;text-align:center; background:var(--score);margin-top:20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);}
        #history div {padding: 2px 0; border-bottom: 1px dashed var(--border); font-family: 'Space Mono', monospace;}
        .top-right-btns{position:fixed;top:5px;right:5px;z-index:10;}
        #settingsbtn {font-size:24px;background:none;border:none;cursor:pointer;padding: 5px 8px;}
        
        /* --- Modal Stilleri --- */
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;z-index:20}
        .modal-content{position:relative;background:var(--score);color:var(--text);padding:20px;border-radius:10px;text-align:center;max-width:85%;width:350px;}
        .modal-close-btn{position:absolute;top:10px;right:10px;font-size:20px;font-weight:700;color:var(--red);background:none;border:none;cursor:pointer;padding:0;line-height:1}
        .modal-action-btn{margin-top:15px;padding:10px;background:var(--blue);color:#fff;border:none;border-radius:5px;display:block;width:80%;margin:10px auto;}
        .tema-btn-group {display: flex; flex-wrap: wrap; justify-content: space-between;}
        .tema-btn-group button {width: 48%; margin: 5px 0.5%; padding: 10px; font-weight: bold; border: 2px solid var(--blue); background: none; color: var(--text); border-radius: 8px; cursor: pointer;}
        .tema-btn-group button.active {background: var(--blue); color: white;}
        #level-bar-container {width: 300px; margin: 15px auto 5px; padding: 5px 0; text-align: center; font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 600; border: 2px solid var(--border); border-radius: 10px; background: var(--score);}
        #level-progress-bar {background-color: #ddd; border-radius: 5px; margin: 5px 10px; height: 10px; overflow: hidden;}
        #level-progress {height: 100%; width: 0%; background-color: var(--blue); transition: width 0.5s ease-in-out;}
        
        /* --- Level Up Modal Stilleri --- */
        #levelUpModal .modal-content {border: 3px solid var(--blue); background: linear-gradient(145deg, var(--bg) 0%, var(--score) 100%); box-shadow: 0 0 20px rgba(var(--blue-rgb), 0.5); animation: bounceIn 0.6s ease-out;}
        @keyframes bounceIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        #levelUpModal h2 {color: var(--blue); font-size: 28px; text-shadow: 0 0 5px rgba(var(--blue-rgb), 0.8);}
        .level-star-emoji {font-size: 48px; margin: 10px 0; display: block; animation: rotateAndGlow 1.5s infinite alternate;}
        @keyframes rotateAndGlow {0% { transform: rotate(0deg) scale(1); text-shadow: 0 0 5px var(--text); } 100% { transform: rotate(3deg) scale(1.05); text-shadow: 0 0 15px var(--blue), 0 0 5px var(--blue); }}
        
        /* --- √ñd√ºl Paketi Modal Stilleri (D√úZELTME YAPILDI) --- */
        #rewardPackModal .modal-content {
            background: linear-gradient(180deg, var(--bg) 0%, var(--score) 100%);
            border: 5px solid gold;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.7);
        }
        #pack-container {
            width: 150px; height: 200px; margin: 20px auto;
            background: linear-gradient(145deg, #a77700, #ffc72c);
            border-radius: 15px; border: 5px solid #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; cursor: pointer;
            transition: transform 0.2s; /* Ge√ßi≈ü s√ºresi kƒ±saltƒ±ldƒ± */
            position: relative; user-select: none;
        }
        #pack-container:not(.open):hover { transform: scale(1.05); }
        /* A√ßƒ±lma animasyonu deƒüi≈ütirildi */
        #pack-container.open { opacity: 0; } /* Sadece gizle */

        #reward-result {
            margin-top: 20px; 
            font-size: 24px; font-weight: bold;
            opacity: 0;
            transition: opacity 0.5s; 
            /* Yeni kart g√∂sterim alanƒ± i√ßin eklendi */
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #reward-result.show { opacity: 1; }
        .reward-unlocked { color: var(--green); font-size: 36px; }
        .reward-nothing { color: var(--red); }
        .pack-ready-text { color: white; font-family: 'Orbitron', sans-serif; font-size: 18px; text-shadow: 0 0 5px #000; }
        
        /* Yeni Kart G√∂sterimi Stili */
        .unlocked-card-display {
            padding: 15px;
            margin: 10px 0;
            border: 3px solid var(--blue);
            border-radius: 10px;
            background: var(--score);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.5s ease-out;
            transform: scale(0.8); /* Ba≈ülangƒ±√ßta k√º√ß√ºk */
            opacity: 0;
        }
        .unlocked-card-display.reveal {
            transform: scale(1); /* B√ºy√ºme animasyonu */
            opacity: 1;
        }
        .unlocked-card-emoji {
            font-size: 48px;
            display: block;
        }

        /* --- Deste Se√ßimi Stilleri --- */
        .card-option {padding: 10px 15px; font-size: 20px; font-weight: bold; border: 2px solid var(--border); background: var(--btn); color: var(--text); border-radius: 8px; cursor: pointer; transition: 0.1s;}
        .card-option.selected-card {background: var(--blue); color: white; border-color: var(--blue); box-shadow: 0 0 5px var(--blue);}

    </style>
</head>
<body>

<div class="top-right-btns">
    <button id="settingsbtn" onclick="togglemodal('settingsmodal', true)">‚öôÔ∏è</button>
</div>

<div id="gamescreen">
    <div id="level-bar-container">
        <div id="level-info"></div>
        <div id="level-progress-bar">
            <div id="level-progress"></div>
        </div>
        <div id="level-points"></div>
    </div>
    <div class="scores" id="scores"></div>
    <div class="pot" id="pot">ü™ôü™ôü™ôü™ôü™ôü™ô</div>
    <div class="buttons" id="actionbuttons"></div>
    <p id="gameover"></p>
    <button id="newgamebtn" style="display:none;" onclick="startgame(25)" data-key="new_game_btn">Yeni Oyun</button>
    <div id="history"></div>
</div>

<div id="settingsmodal" class="modal">
    <div id="settingsmodalcontent" class="modal-content">
        <button class="modal-close-btn" onclick="togglemodal('settingsmodal', false)">x</button>
        <h2 data-key="settings_title">Ayarlar</h2>
        <h3 data-key="theme_selection_title">üé® Tema Se√ßimi</h3>
        <div id="temasecim" class="tema-btn-group">
            <button id="beyaztemabtn" onclick="temasec('beyaz')" data-key="theme_white">‚¨ú Beyaz</button>
            <button id="siyahtemabtn" onclick="temasec('siyah')" data-key="theme_dark">üåë Siyah</button>
            </div>
        <h3 style="margin-top: 25px;" data-key="reset_title">‚ö†Ô∏è Veri Y√∂netimi</h3>
        <button class="modal-action-btn" style="background: var(--red); margin-top: 5px;" onclick="resetAllProgress()" data-key="reset_game_btn">
            Oyunu Sƒ±fƒ±rla (Level, Kartlar, Her ≈ûey)
        </button>
    </div>
</div>

<div id="levelUpModal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="togglemodal('levelUpModal', false)">x</button>
        <span class="level-star-emoji">üåü</span> 
        <h2 data-key="levelup_title"></h2>
        <div id="levelup-rewards"></div>
        <button class="modal-action-btn" onclick="togglemodal('levelUpModal', false)">Paketi A√ß</button> 
    </div>
</div>

<div id="rewardPackModal" class="modal">
    <div class="modal-content">
        <h2 data-key="pack_open_title">üéÅ √ñd√ºl Paketi!</h2>
        <div id="pack-container" onclick="openRewardPack()">
            <span class="pack-ready-text" data-key="pack_click_to_open">A√ßmak i√ßin Tƒ±kla</span>
        </div>
        <div id="reward-result"></div>
        <button id="pack-modal-close-btn" class="modal-action-btn" onclick="togglemodal('rewardPackModal', false); checkNextLevelReward();" style="display:none;">Tamam</button>
    </div>
</div>

<div id="deckselectionmodal" class="modal">
    <div class="modal-content">
        <h2 data-key="deck_title">Deste Se√ßimi</h2>
        <p data-key="deck_info">L√ºtfen oynamak istediƒüiniz 3 kartƒ± se√ßin.</p>
        <div id="available-cards" style="display:flex; justify-content:center; gap: 10px; margin: 15px 0; flex-wrap: wrap;"></div>
        <div id="selected-cards" style="font-size: 24px; margin-bottom: 15px;">Se√ßilenler: <span id="selected-cards-display"></span></div>
        <button id="start-game-deck-btn" class="modal-action-btn" disabled onclick="finalizeDeckSelection()" data-key="deck_finalize">Oyuna Ba≈üla</button>
    </div>
</div>

<script>
    // --- √áEVƒ∞Rƒ∞ VERƒ∞TABANI (G√ºncellendi) ---
    const translations = {
        tr: {
            title: '√á-A-Y Oyunu',
            new_game_btn: 'Yeni Oyun',
            settings_title: 'Ayarlar',
            theme_selection_title: 'üé® Tema Se√ßimi',
            theme_white: '‚¨ú Beyaz',
            theme_dark: 'üåë Siyah',
            deck_title: 'Deste Se√ßimi', 
            deck_info: 'L√ºtfen oynamak istediƒüiniz 3 kartƒ± se√ßin.', 
            deck_finalize: 'Oyuna Ba≈üla', 
            level_info: (level) => `Seviye ${level} üåü`, 
            level_points: (current, required) => `${current}/${required} Puan`, 
            msg_cannot_afford: '‚ùå Bu hamle puanƒ±nƒ±zƒ± √ßok d√º≈ü√ºr√ºyor. L√ºtfen ba≈üka bir kart se√ßin.', 
            msg_game_over_winner: (winner) => `üèÅ Oyun Bitti ‚Äî Kazanan: ${winner}`,
            levelup_title: (level) => `Tebrikler! Seviye ${level} üèÜ`, 
            reset_title: '‚ö†Ô∏è Veri Y√∂netimi',
            reset_game_btn: 'Oyunu Sƒ±fƒ±rla (Level, Kartlar, Her ≈ûey)',
            reset_success: 'Oyun ba≈üarƒ±yla sƒ±fƒ±rlandƒ±! Sayfa yenileniyor...',
            pack_open_title: 'üéÅ √ñd√ºl Paketi!',
            pack_click_to_open: 'A√ßmak i√ßin Tƒ±kla',
            reward_unlocked_card: (cardName) => `Yeni Kart A√ßƒ±ldƒ±: ${cardName}!`,
            reward_nothing: 'ü§∑‚Äç‚ôÇÔ∏è Bu Paketten Bir ≈ûey √áƒ±kmadƒ±.',
            level_reward_info: 'Yeni seviyende bir √∂d√ºl paketi kazandƒ±n! Hemen a√ß!',
            item_button_s_name: 'S Tu≈üu (S√ºp√ºr)', 
            item_button_k_name: 'K Tu≈üu (Ka√ßƒ±r)', 
        },
    };

    // --- YENƒ∞ KART Lƒ∞STESƒ∞ (G√ºncellendi) ---
    const allUnlockableCards = [
        { id: 'button_s', move: 'S', nameKey: 'item_button_s_name', emoji: 'üßπ' }, 
        { id: 'button_k', move: 'K', nameKey: 'item_button_k_name', emoji: 'üëã' }, // EMOJƒ∞ DEƒûƒ∞≈ûTƒ∞Rƒ∞LDƒ∞
    ];

    // --- OYUN DEƒûƒ∞≈ûKENLERƒ∞ (G√ºncellendi) ---
    const adlar = ['sen', 'yz1', 'yz2']; 
    const user_emoji = 'üßë'; 
    const dyn_emo = ['ü§ñ', 'üëΩ', '‚òªÔ∏è', 'üë∂', 'üò∫', 'ü•∏'];
    // K Emojisi Deƒüi≈ütirildi (Yeni Emojiler)
    const move_emojis = {'√á': 'üí∞', 'A': 'ü´≥', 'Y': 'üë®‚Äç‚úàÔ∏è', 'S': 'üßπ', 'K': 'üëã'}; // EMOJƒ∞ DEƒûƒ∞≈ûTƒ∞Rƒ∞LDƒ∞
    let currentLanguage = 'tr'; 
    let p = [0, 0, 0]; 
    let pot = 6; 
    let aktiftema = 'beyaz'; 
    let bitis = false; 
    let hamleler = [[], [], []]; 
    let cooldown = false; 
    let d = {}; 
    let max_skor = 25; 
    let max_rounds = 10; 
    let current_round = 0; 
    let cemo = [user_emoji, '', '']; 
    // OwnedItems sadece √á A Y ve S K tutacak ≈üekilde g√ºncellendi
    let ownedItems = { 'button_s': false, 'button_k': false }; 
    // Diƒüer √∂zel kart deƒüi≈ükenleri kaldƒ±rƒ±ldƒ±
    let current_deck = ['√á', 'A', 'Y']; 
    let last_moves_emojis = ['', '', '']; 
    let ai_decks = [['√á', 'A', 'Y'], ['√á', 'A', 'Y']]; 
    let playerLevel = 1; 
    let totalScore = 0; 
    let pendingLevelRewards = []; 
    
    // --- BA≈ûLANGI√á ---
    window.onload = function() {
        ['gamescreen', 'scores', 'pot', 'gameover', 'newgamebtn', 'settingsmodalcontent', 'temasecim', 'history', 'actionbuttons', 'deckselectionmodal', 'level-bar-container', 'levelUpModal', 'rewardPackModal'].forEach(id => d[id] = document.getElementById(id)); 
        if (!yukle()) {
            setupNewGameEmojis(); 
            temasec('beyaz', true);
            startgame(max_skor); 
        }
        changeLanguage('tr', true);
        d.gamescreen.style.display = 'flex'; 
        checkNextLevelReward(); 
    };

    // *******************************************************
    // ********** KAYIT Sƒ∞STEMƒ∞ FONKSƒ∞YONLARI (G√ºncellendi) **********
    // *******************************************************
    function kaydet() {
        const oyunDurumu = {
            kayit_puanlar: p, kayit_pot: pot, kayit_totalScore: totalScore,
            kayit_playerLevel: playerLevel, kayit_aktiftema: aktiftema, kayit_max_skor: max_skor,
            kayit_max_rounds: max_rounds, kayit_current_round: current_round, kayit_cemo: cemo,
            kayit_ownedItems: ownedItems, 
            kayit_current_deck: current_deck, kayit_ai_decks: ai_decks,
            kayit_pendingLevelRewards: pendingLevelRewards, 
        };
        try { localStorage.setItem('CAY_OYUNU_KAYIT', JSON.stringify(oyunDurumu)); } catch (e) { console.error('Kaydetme hatasƒ±:', e); }
    }

    function yukle() {
        const oyunDurumuJSON = localStorage.getItem('CAY_OYUNU_KAYIT');
        if (oyunDurumuJSON) {
            try {
                const oyunDurumu = JSON.parse(oyunDurumuJSON);
                // Varsayƒ±lan ownedItems g√ºncellendi
                const defaultOwnedItems = { 'button_s': false, 'button_k': false }; 
                ownedItems = { ...defaultOwnedItems, ...(oyunDurumu.kayit_ownedItems || {}) };
                
                p = oyunDurumu.kayit_puanlar || [0, 0, 0];
                pot = oyunDurumu.kayit_pot || 6;
                totalScore = oyunDurumu.kayit_totalScore || 0;
                playerLevel = oyunDurumu.kayit_playerLevel || 1;
                aktiftema = oyunDurumu.kayit_aktiftema || 'beyaz';
                max_skor = oyunDurumu.kayit_max_skor || 25;
                max_rounds = oyunDurumu.kayit_max_rounds || 10; 
                current_round = oyunDurumu.kayit_current_round || 0; 
                cemo = oyunDurumu.kayit_cemo || [user_emoji, '', ''];
                
                current_deck = oyunDurumu.kayit_current_deck || ['√á', 'A', 'Y'];
                ai_decks = oyunDurumu.kayit_ai_decks || [['√á', 'A', 'Y'], ['√á', 'A', 'Y']];
                pendingLevelRewards = oyunDurumu.kayit_pendingLevelRewards || []; 
                bitis = false;

                temasec(aktiftema, true); 
                renderActionButtons();
                guncelle();
                kontrol();
                return true;
            } catch (e) { console.error('Kayƒ±tlƒ± veri y√ºklenemedi/bozuk:', e); return false; }
        }
        return false;
    }

    function resetAllProgress() {
        if (confirm(T('reset_title') + "\n\nUYARI: T√ºm ilerlemeniz (Seviye, A√ßƒ±lan Kartlar, Puanlar) silinecektir. Emin misiniz?")) {
            localStorage.removeItem('CAY_OYUNU_KAYIT');
            p = [0, 0, 0]; pot = 6; bitis = false; hamleler = [[], [], []]; cooldown = false; 
            setupNewGameEmojis(); d.history.innerHTML = ""; 
            d.gameover.innerText = ""; d.newgamebtn.style.display = "none"; 
            d.actionbuttons.querySelectorAll('button').forEach(btn => { btn.disabled = false; btn.classList.remove('cooldown'); }); 
            clearPlayerActionEmojis(); last_moves_emojis = ['', '', '']; 
            playerLevel = 1; totalScore = 0; 
            current_round = 0; 
            // OwnedItems g√ºncellendi
            ownedItems = { 'button_s': false, 'button_k': false }; 
            pendingLevelRewards = []; 
            alert(T('reset_success'));
            window.location.reload(); 
        }
    }

    // --- YARDIMCI FONKSƒ∞YONLAR (Kƒ±saltƒ±ldƒ±) ---
    function T(key, ...args) {
        const value = translations[currentLanguage][key];
        return typeof value === 'function' ? value(...args) : value;
    }
    
    function calculateLevelScore(level) {
        return ((level + 3) * (level + 4)) / 2;
    }

    function getTotalRequiredScoreToReachLevel(level) {
        if (level <= 1) return 0;
        let total = 0;
        for (let i = 1; i < level; i++) {
            total += calculateLevelScore(i);
        }
        return total;
    }
    
    function getCardFullName(id) {
        const card = allUnlockableCards.find(c => c.id === id);
        return card ? T(card.nameKey) : 'Bilinmeyen Kart';
    }

    function getCardData(id) {
        return allUnlockableCards.find(c => c.id === id);
    }

    function updateUIForLanguage() {
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if (key !== 'levelup_title' && key !== 'reset_game_btn') {
                el.innerText = T(key);
            }
        });
        document.querySelector('[data-key="reset_game_btn"]').innerText = T('reset_game_btn');
        document.querySelector('#rewardPackModal h2').innerText = T('pack_open_title');
        document.querySelector('.pack-ready-text').innerText = T('pack_click_to_open');

        renderThemes(); 
        document.title = T('title');
    }
    
    // --- KART ETKƒ∞Sƒ∞ HESAPLAMA (G√úNCELLENDƒ∞) ---
    function calculateMoveEffect(playerIndex, move) {
        let cost = 0;
        
        // S Tu≈üu maliyeti 0 olarak ayarlandƒ±
        if (move === 'S') cost += 0; 
        // K Tu≈üu maliyeti 3 olarak ayarlandƒ±
        if (move === 'K') cost += 3;
        
        return -cost;
    }

    function rasgele(playerIndex) { 
        const deck = ai_decks[playerIndex - 1]; 
        // AI'ƒ±n hamle se√ßimi artƒ±k 'Can\'t afford' kontrol√º olmadan yapƒ±lƒ±yor.
        const safe_moves = deck.filter(move => {
            const effect = calculateMoveEffect(playerIndex, move);
            // AI, nihai iflas sƒ±nƒ±rƒ±nƒ±n -10 olduƒüunu bilerek oynamalƒ±dƒ±r.
            const nihai_iflas_siniri = -10; 
            return (p[playerIndex] + effect) >= nihai_iflas_siniri; 
        });
        
        if (safe_moves.length === 0) {
            // Eƒüer iflas sƒ±nƒ±rƒ±nƒ± ge√ßecek hamle yoksa, temel hamlelere (√áAY) √∂ncelik ver.
            const fallback_moves = deck.filter(move => ['√á', 'A', 'Y'].includes(move));
            if (fallback_moves.length > 0) {
                return fallback_moves[Math.floor(Math.random() * fallback_moves.length)];
            }
            // T√ºm hamleler iflasa g√∂t√ºr√ºyorsa rastgele birini se√ßsin (ka√ßƒ±nƒ±lmaz)
            return deck[Math.floor(Math.random() * deck.length)];
        }
        return safe_moves[Math.floor(Math.random() * safe_moves.length)];
    }
    
    function setupNewGameEmojis() { 
        const shuffled = dyn_emo.sort(() => .5 - Math.random()); 
        cemo[1] = shuffled[0]; 
        cemo[2] = shuffled[1];
    }
    
    function changeLanguage(lang, initial = false) {
        if (currentLanguage !== lang || initial) {
            currentLanguage = lang;
            updateUIForLanguage();
            guncelle();
        }
    }
    
    function togglemodal(id, ac) { 
        const modal = document.getElementById(id); 
        modal.style.display = ac ? 'flex' : 'none'; 
        if (ac) guncelle();
        else restorePlayerActionEmojis();
    }

    function resetCurrentGameState() {
        p = [0, 0, 0]; pot = 6; bitis = false; hamleler = [[], [], []]; cooldown = false; 
        setupNewGameEmojis(); d.history.innerHTML = ""; 
        d.gameover.innerText = ""; d.newgamebtn.style.display = "none"; 
        d.actionbuttons.querySelectorAll('button').forEach(btn => { btn.disabled = false; btn.classList.remove('cooldown'); }); 
        clearPlayerActionEmojis(); last_moves_emojis = ['', '', '']; 
        current_round = 0; 
    }
    
    function getAvailableMoves() {
        let moves = ['√á', 'A', 'Y'];
        allUnlockableCards.forEach(card => {
            if (ownedItems[card.id]) {
                moves.push(card.move);
            }
        });
        return moves;
    }
    
    function selectAIDeck() {
        const allAvailableMoves = getAvailableMoves();
        const num_moves_to_select = 3;
        
        let shuffled1 = allAvailableMoves.sort(() => 0.5 - Math.random());
        ai_decks[0] = shuffled1.slice(0, num_moves_to_select);
        
        let shuffled2 = allAvailableMoves.sort(() => 0.5 - Math.random());
        ai_decks[1] = shuffled2.slice(0, num_moves_to_select);
    }

    function startgame(score_limit) {
        max_skor = score_limit; 
        max_rounds = 10; 
        resetCurrentGameState();
        
        const allButtonsOwned = Object.values(ownedItems).some(val => val);

        if (allButtonsOwned) {
            // Destek Se√ßimi Modalƒ± a√ßƒ±lƒ±r. Finalize edildiƒüinde oyun ba≈ülar.
            renderDeckSelectionModal(); 
        } else {
            // Deste Se√ßimi yoksa, varsayƒ±lan desteyle ve AI destesiyle oyuna ba≈üla.
            current_deck = ['√á', 'A', 'Y'];
            selectAIDeck(); 
            renderActionButtons(); 
            guncelle(); 
        }
    }
    
    // --- DESTE SE√áƒ∞M MANTIƒûI (Kƒ±saltƒ±ldƒ±) ---
    let selected_moves = ['√á', 'A', 'Y'];

    function renderDeckSelectionModal() {
        const availableMoves = getAvailableMoves();
        const container = document.getElementById('available-cards');
        
        selected_moves = current_deck.filter(move => availableMoves.includes(move)); 
        if (selected_moves.length !== 3) selected_moves = availableMoves.slice(0, 3);
        
        container.innerHTML = availableMoves.map(move => {
            const cardData = getCardData(allUnlockableCards.find(c => c.move === move)?.id || '');
            const cardName = cardData ? T(cardData.nameKey) : move;
            return `<button class="card-option" onclick="toggleCardSelection('${move}')" title="${cardName}">${move}</button>`;
        }).join('');
        
        renderDeckSelectionModalUIOnly();
        togglemodal('deckselectionmodal', true);
    }
    
    function toggleCardSelection(move) {
        const index = selected_moves.indexOf(move);
        if (index > -1) selected_moves.splice(index, 1); 
        else if (selected_moves.length < 3) selected_moves.push(move); 
        renderDeckSelectionModalUIOnly();
    }
    
    function renderDeckSelectionModalUIOnly() {
        const display = document.getElementById('selected-cards-display');
        const finalizeBtn = document.getElementById('start-game-deck-btn');
        const container = document.getElementById('available-cards');
        
        container.querySelectorAll('.card-option').forEach(btn => {
            const move = btn.innerText; 
            btn.classList.toggle('selected-card', selected_moves.includes(move));
            btn.disabled = selected_moves.length === 3 && !selected_moves.includes(move);
        });
        
        const displayMoves = selected_moves.map(move => `${move}`); 
        display.innerHTML = displayMoves.join(', ');
        finalizeBtn.disabled = selected_moves.length !== 3;
    }
    
    function finalizeDeckSelection() {
        if (selected_moves.length === 3) {
            current_deck = selected_moves.slice();
            // Yalnƒ±zca burada desteler se√ßilir ve oyun ba≈ülar.
            selectAIDeck(); 
            togglemodal('deckselectionmodal', false);
            renderActionButtons();
            guncelle();
        }
    }

    function renderActionButtons() {
        if (bitis) {
            d.actionbuttons.innerHTML = '';
            return;
        }
        
        let html = current_deck.map(move => 
            `<button id="btn${move.toLowerCase()}" onclick="oyuncu('${move}')" data-text="${move}">${move}</button>`
        ).join('');
        
        d.actionbuttons.innerHTML = html;
        
        if (cooldown) {
            d.actionbuttons.querySelectorAll('button').forEach(btn => { 
                btn.disabled = true;
                btn.classList.add('cooldown'); 
            });
        }
    }

    // --- TEMA MANTIƒûI (Kƒ±saltƒ±ldƒ±) ---
    function renderThemes() {
        const allThemes = [
            { id: 'beyaz', key: 'theme_white' },
            { id: 'siyah', key: 'theme_dark' },
        ];
        
        let html = '';
        allThemes.forEach(theme => {
            const isActive = aktiftema === theme.id ? 'active' : '';
            // Buton geni≈üliƒüi 48% olarak ayarlandƒ±, √ß√ºnk√º 2 buton kaldƒ±.
            html += `<button id="${theme.id}temabtn" onclick="temasec('${theme.id}')" class="${isActive}" data-key="${theme.key}" style="width: 48%;">${T(theme.key)}</button>`;
        });
        
        d.temasecim.innerHTML = html;
    }
    
    function temasec(tema, initial = false) {
        aktiftema = tema;
        document.body.classList.remove('dark'); 
        if (tema === 'siyah') document.body.classList.add('dark');

        if (!initial) renderThemes();
    }

    // --- OYUN MANTIƒûI (G√úNCELLENDƒ∞) ---

    function oyuncu(h) {
        if (bitis || cooldown) return; 
        
        current_round++; 

        cooldown = true; 
        d.actionbuttons.querySelectorAll('button').forEach(btn => { 
            btn.disabled = true;
            btn.classList.add('cooldown'); 
        });
        
        clearPlayerActionEmojis(); 

        const mv = [h, rasgele(1), rasgele(2)];
        
        // Bu kontrol√º `tursonucu` i√ßinde zaten yapƒ±yoruz, burada tekrar yapƒ±lmasƒ±na gerek yok.
        // Ama√ß, t√ºm hareketlerin e≈ü zamanlƒ± olduƒüunu varsaymaktƒ±r.
        
        tursonucu(mv);
        
        setTimeout(() => { 
            cooldown = false; 
            d.actionbuttons.querySelectorAll('button').forEach(btn => { 
                btn.classList.remove('cooldown'); 
                btn.disabled = bitis; 
            });
        }, 3000); 
    }

    function tursonucu(mv) {
        for (let i = 0; i < 3; i++) hamleler[i].push(mv[i]); 
        const onceki = pot; 
        const a = mv.filter(x => x === 'A').length; 
        const c = mv.filter(x => x === '√á').length; 
        const y = mv.filter(x => x === 'Y').length;
        const s = mv.filter(x => x === 'S').length; 
        const k = mv.filter(x => x === 'K').length; 
        
        let kazanc = [0, 0, 0]; 
        let animationClass = '';
        let duration = 300; 
        const initial_p0 = p[0];
        let pot_alindi = false;
        
        // 0. √ñzel Kart Maliyetlerini Uygula
        mv.forEach((move, i) => {
            const cost = -calculateMoveEffect(i, move); // Maliyet pozitif olarak alƒ±nƒ±r.
            kazanc[i] -= cost;
        });
        
        // 1. KAZANANIN BELƒ∞RLENMESƒ∞ (√ñncelik Sƒ±rasƒ±: Y > K > √á > A)
        
        const y_players = mv.map((m, i) => m === 'Y' ? i : -1).filter(i => i !== -1);
        const k_players = mv.map((m, i) => m === 'K' ? i : -1).filter(i => i !== -1);
        const c_players = mv.map((m, i) => m === '√á' ? i : -1).filter(i => i !== -1);
        const a_players = mv.map((m, i) => m === 'A' ? i : -1).filter(i => i !== -1);
        const s_players = mv.map((m, i) => m === 'S' ? i : -1).filter(i => i !== -1);
        
        let kazanan_tu≈ü = null;
        let kazanan_indeksler = [];

        // Y (Yakala) Kontrol√º: K veya √á var mƒ±? (Y en y√ºksek √∂nceliƒüe sahip)
        // Y, yalnƒ±zca K veya √á'den herhangi biri basƒ±ldƒ±ysa kazanƒ±r.
        if (y > 0 && (k > 0 || c > 0)) {
             kazanan_tu≈ü = 'Y';
             kazanan_indeksler = y_players;
        } 
        
        // K (Ka√ßƒ±r) Kontrol√º: Y basƒ±lmadƒ±ysa ve K basƒ±ldƒ±ysa
        // K, yalnƒ±zca Y basƒ±lmadƒ±ysa ve K basƒ±ldƒ±ysa potu alƒ±r.
        else if (k > 0 && y === 0) {
            kazanan_tu≈ü = 'K';
            kazanan_indeksler = k_players;
        } 
        
        // √á (√áal) Kontrol√º: K ve Y basƒ±lmadƒ±ysa ve √á basƒ±ldƒ±ysa
        // √á, yalnƒ±zca K ve Y basƒ±lmadƒ±ysa ve A basƒ±ldƒ±ysa kazanƒ±r.
        else if (c > 0 && k === 0 && y === 0) {
            if (a > 0) {
                 kazanan_tu≈ü = '√á';
                 kazanan_indeksler = c_players;
            }
        } 
        
        // A (Al) Kontrol√º: √á, K ve Y basƒ±lmadƒ±ysa ve A basƒ±ldƒ±ysa
        else if (a > 0 && c === 0 && k === 0 && y === 0) {
             // A kazanƒ±r (eƒüer S basƒ±ldƒ±ysa, A hala kazanƒ±r √ß√ºnk√º A'nƒ±n √∂nceliƒüi S'den y√ºksektir)
             kazanan_tu≈ü = 'A';
             kazanan_indeksler = a_players;
        }

        // 2. KAZAN√á DAƒûITIMI
        if (kazanan_tu≈ü !== null) {
            // Pot kazananlar arasƒ±nda e≈üit payla≈üƒ±lƒ±r
            const pay = onceki / kazanan_indeksler.length;
            kazanan_indeksler.forEach(i => { kazanc[i] += pay; });
            pot = 6;
            pot_alindi = true;
            animationClass = kazanan_indeksler.includes(0) ? 'pot-flash-green' : 'pot-flash-red';
        } 
        
        // 3. S (S√ºp√ºr) Kontrol√º (Pot hala alƒ±nmadƒ±ysa)
        else {
             // Hi√ßbir *kazanma* ko≈üulu ger√ßekle≈ümediyse ve S basƒ±ldƒ±ysa S kazanƒ±r.
             if (s > 0) {
                 const pay = onceki / s_players.length;
                 s_players.forEach(i => { kazanc[i] += pay; });
                 pot = 6;
                 pot_alindi = true;
                 animationClass = s_players.includes(0) ? 'pot-flash-green' : 'pot-flash-red';
             }
        }
        
        // 4. Pot Kƒ±sƒ±tlamasƒ± (Pot hala alƒ±nmadƒ±ysa pot artar)
        if (!pot_alindi) { 
            // Pot artar (√á/Y/K/A/S hamleleri bir kazanan √ßƒ±karmazsa)
            pot += 6;
            animationClass = 'pot-flash-accumulate'; duration = 1200; 
            pot = Math.min(pot, 30); // Pot limiti korundu
            pot = Math.max(6, pot); // Pot alƒ±nmadƒ±ysa en az 6 olmalƒ±
        }
        
        // 5. Skorlarƒ± Uygula
        for (let i = 0; i < 3; i++) p[i] += kazanc[i]; 
        
        // 6. Seviye Puanƒ±nƒ± G√ºncelle
        const final_p0 = p[0];
        const p0_change = final_p0 - initial_p0;
        if (p0_change > 0) totalScore += p0_change;

        checkLevelUp();

        if (animationClass) {
            d.pot.classList.add(animationClass);
            setTimeout(() => { d.pot.classList.remove(animationClass); }, duration);
        }

        const roundNumber = current_round; 
        // ƒ∞stenen format: sƒ±ra. HAMLELER
        let s_text = `${roundNumber}. ${mv.join('')}`; 
        d.history.innerHTML += `<div>${s_text}</div>`;
        d.history.scrollTop = d.history.scrollHeight; 
        
        guncelle(); 
        kontrol(); 

        mv.forEach((move, i) => {
            const move_emoji = move_emojis[move];
            last_moves_emojis[i] = move_emoji; 
            const playerActionEmojiSpan = document.getElementById(`player-action-emoji-${i}`);
            if (playerActionEmojiSpan) {
                playerActionEmojiSpan.innerText = move_emoji;
                playerActionEmojiSpan.classList.add('active');
            }
        });
    }
    
    // --- SEVƒ∞YE √ñD√úL MANTIƒûI (D√úZELTƒ∞LDƒ∞, S-K Kartlarƒ± ile Uyumlula≈ütƒ±rƒ±ldƒ±) ---
    function checkNextLevelReward() {
        if (pendingLevelRewards.length > 0 && d.levelUpModal.style.display !== 'flex') {
            const nextLevel = pendingLevelRewards[0];
            showLevelUpModal(nextLevel);
        }
    }

    function showLevelUpModal(newLevel) {
        togglemodal('levelUpModal', true); 
        document.getElementById('levelUpModal').querySelector('h2').innerText = T('levelup_title', newLevel);
        
        const rewardsHTML = `<h3>üéÅ Paket ƒ∞√ßeriƒüi:</h3><ul><li>${T('level_reward_info')}</li></ul>`;
        document.getElementById('levelup-rewards').innerHTML = rewardsHTML;

        document.querySelector('#levelUpModal .modal-action-btn').onclick = () => {
            togglemodal('levelUpModal', false);
            togglemodal('rewardPackModal', true); 
            
            const packContainer = document.getElementById('pack-container');
            const resultDiv = document.getElementById('reward-result');
            const closeBtn = document.getElementById('pack-modal-close-btn');
            
            // Modal a√ßƒ±lƒ±≈üƒ±nda paket g√∂r√ºn√ºm√ºn√º sƒ±fƒ±rla
            packContainer.classList.remove('open');
            packContainer.style.opacity = '1';
            packContainer.style.transform = '';
            packContainer.querySelector('.pack-ready-text').style.display = 'block';

            resultDiv.classList.remove('show');
            resultDiv.innerHTML = '';
            closeBtn.style.display = 'none';
        };
    }
    
    // Paketi A√ßma Fonksiyonu (D√úZELTƒ∞LDƒ∞)
    function openRewardPack() {
        const packContainer = document.getElementById('pack-container');
        const resultDiv = document.getElementById('reward-result');
        const closeBtn = document.getElementById('pack-modal-close-btn');

        if (packContainer.classList.contains('open') || pendingLevelRewards.length === 0) return;

        packContainer.classList.add('open');
        packContainer.querySelector('.pack-ready-text').style.display = 'none';
        
        const currentLevel = pendingLevelRewards.shift(); 

        // Paketin gizlenme animasyonu bittikten sonra sonucu g√∂ster
        setTimeout(() => {
            let rewardCardId = null;
            const hasReward = Math.random() < 0.5;

            if (hasReward) {
                const unopenedCards = allUnlockableCards.filter(card => !ownedItems[card.id]);
                
                if (unopenedCards.length > 0) {
                    const randomIndex = Math.floor(Math.random() * unopenedCards.length);
                    rewardCardId = unopenedCards[randomIndex].id;
                    ownedItems[rewardCardId] = true; 
                    kaydet();
                } 
            }
            
            // Sonucu hazƒ±rlama
            if (rewardCardId) {
                const cardData = getCardData(rewardCardId);
                const cardName = T(cardData.nameKey);
                
                resultDiv.innerHTML = `
                    <span class="reward-unlocked">‚ú® ${T('reward_unlocked_card', cardName)}</span>
                    <div class="unlocked-card-display">
                        <span class="unlocked-card-emoji">${cardData.emoji}</span>
                        ${cardName}
                    </div>
                `;
                
                // Kartƒ±n g√∂sterim animasyonunu ba≈ülat
                setTimeout(() => {
                    document.querySelector('.unlocked-card-display').classList.add('reveal');
                }, 10);
                guncelle();
            } else {
                resultDiv.innerHTML = `<span class="reward-nothing">${T('reward_nothing')}</span>`;
            }

            resultDiv.classList.add('show');
            closeBtn.style.display = 'block';
            
        }, 300); // CSS'deki pack-container ge√ßi≈ü s√ºresi (0.2s) ile uyumlu olarak ayarlandƒ±.
    }

    function checkLevelUp() {
        while (totalScore >= getTotalRequiredScoreToReachLevel(playerLevel + 1)) {
            playerLevel++;
            pendingLevelRewards.push(playerLevel); 
            kaydet();
            guncelle(); 
        }
        checkNextLevelReward();
    }

    function clearPlayerActionEmojis() {
        document.querySelectorAll('.player-action-emoji').forEach(span => {
            span.classList.remove('active');
            span.innerText = '';
        });
    }

    function restorePlayerActionEmojis() {
        if (!last_moves_emojis[0]) return; 
        
        last_moves_emojis.forEach((emoji, i) => {
            if (emoji) {
                const playerActionEmojiSpan = document.getElementById(`player-action-emoji-${i}`);
                if (playerActionEmojiSpan) {
                    playerActionEmojiSpan.innerText = emoji;
                    playerActionEmojiSpan.classList.add('active');
                }
            }
        });
    }

    function kontrol() {
        if (bitis) return;
        
        // ƒ∞flas Sƒ±nƒ±rƒ± -10'da tutuldu.
        const nihai_iflas_siniri = -10;
        
        const iflas_edenler = p.map((score, i) => score < nihai_iflas_siniri ? i : -1).filter(i => i !== -1);
        
        if (iflas_edenler.length > 0) {
            bitis = true; kaydet(); d.actionbuttons.innerHTML = '';
            const iflas_etmeyenler = [0, 1, 2].filter(i => !iflas_edenler.includes(i));
            let kazananlar_ad = '';
            if (iflas_etmeyenler.length > 0) {
                 const max_score_among_survivors = Math.max(...iflas_etmeyenler.map(i => p[i]));
                 const final_winners = iflas_etmeyenler.filter(i => p[i] === max_score_among_survivors);
                 kazananlar_ad = final_winners.map(i => adlar[i]).join(', ');
                 d.gameover.innerText = T('msg_game_over_winner', kazananlar_ad) + " (ƒ∞flas nedeniyle)";
            } else { d.gameover.innerText = "üèÅ Oyun Bitti ‚Äî Herkes ƒ∞flas Etti. Kazanan Yok."; }

            d.newgamebtn.style.display = "inline-block"; return; 
        }
        
        if (current_round >= max_rounds) {
            bitis = true; kaydet(); d.actionbuttons.innerHTML = ''; 
            const mx = Math.max(...p);
            const kazananlar_ad = p.map((p, i) => p === mx ? adlar[i] : '').filter(n => n).join(', ');
            d.gameover.innerText = `üèÅ Oyun Bitti ‚Äî ${max_rounds} Hamle Sonunda Kazanan: ${kazananlar_ad}`;
            d.newgamebtn.style.display = "inline-block"; return; 
        }
    }

    // **************** G√úNCELLEME VE RENDER ******************
    
    function renderPotCoins(currentPot) {
        if (currentPot <= 0) return '';
        const coins_per_row = 6;
        const total_rows = Math.ceil(currentPot / coins_per_row);
        let html_content = '';
        for (let i = 0; i < total_rows; i++) {
            const coins_in_row = Math.min(coins_per_row, currentPot - (i * coins_per_row));
            const coin_string = 'ü™ô'.repeat(coins_in_row);
            html_content += `<div class="coin-row">${coin_string}</div>`;
        }
        return html_content;
    }

    function renderLevelBar() {
        const currentLevel = playerLevel;
        const scoreAtStartOfCurrentLevel = getTotalRequiredScoreToReachLevel(currentLevel); 
        const pointsToNextLevel = calculateLevelScore(currentLevel); 
        const scoreInCurrentLevel = Math.max(0, totalScore - scoreAtStartOfCurrentLevel);
        const percentage = Math.min(100, (scoreInCurrentLevel / pointsToNextLevel) * 100);
        
        document.getElementById('level-info').innerText = T('level_info', currentLevel); 
        document.getElementById('level-points').innerText = T('level_points', Math.floor(scoreInCurrentLevel), Math.floor(pointsToNextLevel));
        document.getElementById('level-progress').style.width = `${percentage}%`;
    }
    
    function guncelle() {
        d.scores.innerHTML = p.map((p, i) => 
            `<div class="player-score">
                <span class="player-action-emoji" id="player-action-emoji-${i}"></span>
                <span class="player-emoji">${cemo[i]}</span>
                ${Math.floor(p)}
            </div>`
        ).join('');
        
        d.pot.innerHTML = renderPotCoins(Math.floor(pot)); 
        
        renderLevelBar(); 
        renderThemes(); 
        renderActionButtons(); 
        temasec(aktiftema, true); 
        restorePlayerActionEmojis(); 
    }
</script>
</body>
</html>