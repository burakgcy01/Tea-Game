<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√á-A-Y Oyunu</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=VT323&display=swap" rel="stylesheet">
    <style>
        /* CSS Deƒüi≈ükenleri (Temalar) */
        :root{--bg:#f8f8f8;--text:#111;--score:#fff;--border:#ddd;--blue:#007bff;--green:#4CAF50;--btn:#eee;--main-bg:#f8f8f8;--inv-bg:rgba(255,255,255,0.95);--red:#dc3545;--yellow:#ffc107}
        .dark{--bg:#000;--text:#fff;--score:rgba(255,255,255,.1);--border:#333;--blue:#0099ff;--green:#4CAF50;--main-bg:#000;--inv-bg:rgba(0,0,0,0.9);--red:#ff4444;--yellow:#ffeb3b}
        .retro{--bg:#020b02;--text:#39ff14;--score:rgba(57, 255, 20, 0.1);--border:#1a7a0f;--blue:#39ff14;--green:#00c000;--main-bg:#000;--inv-bg:rgba(2,11,2,0.95);--red:#ff0000;--yellow:#ffff00}
        .retro h1,.retro h2,.retro .kupa-mesaji{text-shadow:0 0 5px var(--text), 0 0 10px var(--text)}
        .retro .scores,.retro .pot,.retro .status,.retro #history{border:2px solid var(--border);box-shadow:0 0 8px var(--text) inset}
        .retro .buttons button{font-family:'VT323', monospace; background:var(--bg); color:var(--text); border:1px solid var(--border); box-shadow:0 0 5px var(--text) !important}
        .retro .buttons button:hover{background:rgba(57, 255, 20, 0.2)}
        .retro .modal-content{border:2px solid var(--text); box-shadow:0 0 15px var(--text)}

        /* Genel Stiller */
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;margin:0;padding:10px;min-height:100vh;box-sizing:border-box;transition:.3s}h1{margin:6px 0}
        #gameScreen{display:none;align-items:center;flex-direction:column;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;max-width:350px}
        .scores,.pot,.status{margin:6px 0;padding:8px;border-radius:10px;background:var(--score);border:1px solid var(--border);width:300px;text-align:center;box-sizing:border-box;transition:.3s}
        .scores{display:flex;justify-content:space-around;padding:15px 8px}
        .player-score{text-align:center;font-size:18px;font-weight:700;line-height:1.2}.player-emoji{font-size:30px;margin-bottom:5px;display:block}
        .buttons{display:flex;justify-content:center}.buttons button{font-family:'Orbitron',sans-serif;font-size:24px;font-weight:600;margin:5px;padding:10px 16px;border-radius:10px;border:1px solid #aaa;background:var(--btn);cursor:pointer}
        #history{width:300px;height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:5px;font-size:13px;text-align:left;background:var(--score);margin-top:12px}.kupa-mesaji{font-size:20px;font-weight:700;color:var(--green);margin-top:10px}
        .top-right-btns{position:fixed;top:5px;right:5px;left:5px;display:flex;justify-content:flex-end;width:auto;z-index:10}#settingsBtn{font-size:24px;background:none;border:none;cursor:pointer}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;justify-content:center;align-items:center;z-index:20}
        .modal-content{position:relative;background:var(--score);color:var(--text);padding:20px;border-radius:10px;text-align:center;max-width:85%;width:350px;box-shadow:0 0 20px rgba(255,255,255,.5);transition:.3s}
        .modal-content h2{font-family:'Orbitron',sans-serif;color:var(--blue);margin-top:0}
        .modal-close-btn{position:absolute;top:10px;right:10px;font-size:20px;font-weight:700;color:var(--red);background:none;border:none;cursor:pointer;padding:0;line-height:1}
        .modal-action-btn{margin-top:15px;padding:8px 20px;background:var(--blue);color:#fff;border:none;border-radius:5px;display:block;width:80%;margin:10px auto;padding:10px}
        .tema-btn-group {display: flex; flex-wrap: wrap; justify-content: space-between;}
        .tema-btn-group button {width: 32%; margin: 5px 0.5%; padding: 10px; font-weight: bold; border: 2px solid var(--blue); background: none; color: var(--text); border-radius: 8px; cursor: pointer;}
        .tema-btn-group button.active {background: var(--blue); color: white;}
        #mainMenu{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;position:fixed;top:0;left:0;width:100%;background:var(--main-bg);z-index:15;transition:.3s}
        #mainMenu h1{font-size:40px;font-family:'Orbitron',sans-serif;color:var(--text);margin-bottom:50px}
        #mainMenu button{font-size:24px;padding:15px 30px;border:none;border-radius:15px;background:#FF9800;color:white;cursor:pointer;box-shadow:0 5px 0 #E65100;transition:all .1s}
        #lengthButtons button{margin: 10px; padding: 10px 20px; font-size: 18px; border-radius: 8px; border: 2px solid var(--blue); background: none; color: var(--text); cursor: pointer;}
        #lengthButtons button:hover{background: rgba(0, 123, 255, 0.1);}
    
        /* Hedef Skor HUD Stilleri */
        #maxScoreDisplay {
            position: fixed;
            top: 5px;
            left: 5px;
            font-family: 'VT323', monospace;
            font-size: 40px;
            font-weight: bold;
            color: var(--blue);
            text-shadow: 0 0 5px var(--text);
            z-index: 10;
            opacity: 0.9;
            display: none; 
            line-height: 1;
        }

        /* Envanter & G√∂rev Butonlarƒ± */
        #inventoryBtn, #missionBtn {position: fixed; bottom: 10px; font-size: 30px; background: var(--blue); color: white; border: 2px solid var(--border); border-radius: 50%; width: 50px; height: 50px; display: none; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 19; line-height: 1;}
        #inventoryBtn { right: 10px; }
        #missionBtn { left: 10px; }

        /* G√∂rev Butonu √úzerindeki Tik */
        #missionBtn::after {content: attr(data-status-icon); position: absolute; top: -5px; right: -5px; font-size: 16px; background: var(--green); color: white; border-radius: 50%; padding: 2px 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); line-height: 1; display: none;}
        #missionBtn[data-status-icon="‚úÖ"]::after {display: block;}

        /* Envanter Modalƒ± */
        #inventoryModal .modal-content {position: fixed; bottom: 0; left: 50%; transform: translate(-50%, 100%); width: 95%; max-width: 400px; background: var(--inv-bg); border-top: 3px solid var(--blue); border-radius: 15px 15px 0 0; box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: transform 0.4s ease-out; padding: 15px; color: var(--text); text-align: left; z-index: 19; }
        #inventoryModal.active .modal-content { transform: translate(-50%, 0); }
        #inventoryContainer {display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; min-height: 100px;}

        /* G√∂rev Modalƒ± */
        #missionModal .modal-content {max-width: 95%; width: 400px;}
        .mission-info-box {padding: 15px; border: 2px solid var(--blue); border-radius: 10px; margin-bottom: 15px; background: var(--score); text-align: center;}
        
        /* DRAG-MERGE Stilleri */
        .inventory-item {text-align: center; padding: 8px; border: 1px dashed var(--border); border-radius: 5px; background: var(--score); font-size: 14px; font-weight: 700; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: grab; transition: background-color 0.2s, box-shadow 0.2s; min-height: 80px;}
        .inventory-item:hover {box-shadow: 0 0 5px var(--blue);}
        .dragging {opacity: 0.4; border: 2px dashed var(--red);}
        .drop-target {box-shadow: 0 0 10px 3px var(--green) inset; border: 2px solid var(--green); transform: scale(1.05);}
    </style>
</head>
<body>

<div id="maxScoreDisplay"></div> 
<div class="top-right-btns"><button id="settingsBtn" onclick="toggleModal('settingsModal', true)">‚öôÔ∏è</button></div>

<div id="mainMenu">
    <h1>ü´ñ √á-A-Y Oyunu</h1>
    <p>Oyun Uzunluƒüunu Se√ß:</p>
    <div id="lengthButtons">
        <button onclick="startGame(15, 2)">Kƒ±sa (15 Puan) - 2 ü™ô</button>
        <button onclick="startGame(25, 4)">Normal (25 Puan) - 4 ü™ô</button>
        <button onclick="startGame(35, 6)">Uzun (35 Puan) - 6 ü™ô</button>
    </div>
    <p>Oyun √ßalƒ±≈ümƒ±yorsa Chrome ile birlikte a√ßƒ±n.</p>
</div>

<div id="gameScreen">
    <div class="scores" id="scores"></div>
    <div class="pot" id="pot">Ortadaki Para: 6</div>
    <div class="status" id="status">Hamleni se√ß</div>
    <div class="buttons" id="actionButtons">
        <button id="btnC" onclick="oyuncu('√á')">√á</button>
        <button id="btnA" onclick="oyuncu('A')">A</button>
        <button id="btnY" onclick="oyuncu('Y')">Y</button>
    </div>

    <p id="gameOver"></p>
    <button id="newGameBtn" style="display:none;" onclick="resetToMenu()">Yeni Oyun</button>
    
    <div id="history"></div>
</div>

<button id="inventoryBtn" onclick="toggleInventory(true)">üéí</button>
<button id="missionBtn" onclick="renderMissions()" data-status-icon="">üìú</button>

<div id="inventoryModal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="toggleInventory(false)">X</button>
        <h2 style="text-align: center; color: var(--blue);">üéí Envanter (Jeton: 0)</h2>
        <div id="inventoryContainer"></div>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div id="settingsModalContent" class="modal-content">
        <button class="modal-close-btn" onclick="toggleModal('settingsModal', false)">X</button>
        <h2>Ayarlar</h2>
        
        <h3>üé® Tema Se√ßimi</h3>
        <div id="temaSecim" class="tema-btn-group">
            <button id="beyazTemaBtn" onclick="temaSec('beyaz')">‚¨ú Beyaz</button>
            <button id="siyahTemaBtn" onclick="temaSec('siyah')">üåë Siyah</button>
            <button id="retroTemaBtn" onclick="temaSec('retro')">üñºÔ∏è Retro</button>
        </div>
        
        <button class="modal-action-btn" onclick="toggleModal('settingsModal', false); toggleModal('howToPlayModal', true)">‚ùì Nasƒ±l Oynanƒ±r</button>
        <button class="modal-action-btn" onclick="toggleModal('settingsModal', false); toggleModal('creditsModal', true)">‚≠ê K√ºnye (Credits)</button>
    </div>
</div>

<div id="missionModal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="toggleModal('missionModal', false)">X</button>
        <h2 style="color: var(--blue);">üìú Aktif G√∂rev</h2>
        <div id="missionContainer">
            </div>
    </div>
</div>

<div id="howToPlayModal" class="modal">
    <div id="howToPlayContent" class="modal-content" style="text-align: left;">
        <button class="modal-close-btn" onclick="toggleModal('howToPlayModal', false)">X</button>
        <h2>‚ùì Nasƒ±l Oynanƒ±r</h2>
        <p>Oyunun adƒ± √á-A-Y, yani √áal, Al, Yakala. 3 ki≈üiyle oynanƒ±r. Herkes √á, A, ya da Y yazar. Orta her tur 6 puan (para) √ºretir. Oyuncular bu parayƒ± almaya √ßalƒ±≈üƒ±r. A(l) diyen parayƒ± alƒ±r. √á(al) diyen alandan √ßalar. Y(akala) diyen √ßalanƒ± yakalar (ve para ona ge√ßer). Bir tur kimse al demezse para birikir. Sƒ±rayla √á-A-Y yazan oyuncu 4 puan kazanƒ±r.</p>
    </div>
</div>

<div id="creditsModal" class="modal">
    <div id="creditsContent" class="modal-content">
        <button class="modal-close-btn" onclick="toggleModal('creditsModal', false)">X</button>
        <h2>Credits</h2>
        <p>NfShf Games</p>
        <p>ChatGPT & Gemini</p>
    </div>
</div>

<script>
    // Sabitler ve Global Deƒüi≈ükenler
    const ADLAR = ['Sen', 'YZ1', 'YZ2']; 
    const USER_EMOJI = 'üßë'; 
    const DYN_EMO = ['ü§ñ', 'üëΩ', '‚òªÔ∏è', 'üë∂', 'üò∫', 'ü•∏'];
    const BIRLESTIRME_PARCA_SAYISI = 2;
    const MISSION_REWARD = 3; 
    
    // ENVANTER VE G√ñREV YAPILARI
    const ITEMS_DEFAULT = { 
        jeton: { name: 'Jeton', emoji: 'ü™ô', list: [] },
        garnetParca: { name: 'Garnet Par√ßa', emoji: 'üí†', list: [] },
        garnetKupa: { name: 'Garnet Kupa', emoji: 'üèÜ', list: [] },
        serpantinParca: { name: 'Serpantin Par√ßa', emoji: 'üêç', list: [] },
        serpantinKupa: { name: 'Serpantin Kupa', emoji: 'üëë', list: [] },
        masterRozet: { name: '√áaylarƒ±n Efendisi Rozeti', emoji: 'üèÖ', list: [] }
    };
    let ITEMS = JSON.parse(JSON.stringify(ITEMS_DEFAULT)); 

    
    const MISSIONS = {
        'bonus_cay_x2': { name: 'Bir oyunda iki kez √áAY yaz', progress: 0, required: 2 },
        'no_c_game': { name: 'Bir oyunu √á demeden kazan', progress: false, required: true },
        'defeat_smiley': { name: '‚òªÔ∏è karakterini bir kez yen', progress: false, required: true },
        'caca√ßa': { name: '√áA√áA√áA yaz', progress: 0, required: 1 }, 
        'big_win': { name: 'En az 15 puanƒ± tek hamlede kazan', progress: false, required: true }
    };
    
    // Deƒüi≈ükenlerin varsayƒ±lan deƒüerleri (Sƒ±fƒ±rlama i√ßin kullanƒ±lƒ±r)
    const DEFAULT_STATE = {
        p: [0, 0, 0], pot: 6, aktifTema: 'beyaz', bitis: false, 
        hamleler: [[], [], []], cooldown: false, MAX_SKOR: 30, 
        KAZANC_JETON: 5, nextUniqueId: 1, draggedItemInfo: null, 
        activeMissionKey: null, activeMissionCompleted: false, 
        previousMissionKey: null, cEmo: [USER_EMOJI, '', '']
    };

    let p = DEFAULT_STATE.p.slice(); 
    let pot = DEFAULT_STATE.pot; 
    let aktifTema = DEFAULT_STATE.aktifTema; 
    let bitis = DEFAULT_STATE.bitis; 
    let hamleler = DEFAULT_STATE.hamleler.map(arr => arr.slice()); 
    let cooldown = DEFAULT_STATE.cooldown; 
    let d = {}; 
    let MAX_SKOR = DEFAULT_STATE.MAX_SKOR; 
    let KAZANC_JETON = DEFAULT_STATE.KAZANC_JETON; 
    let nextUniqueId = DEFAULT_STATE.nextUniqueId; 
    let draggedItemInfo = DEFAULT_STATE.draggedItemInfo; 
    let activeMissionKey = DEFAULT_STATE.activeMissionKey;
    let activeMissionCompleted = DEFAULT_STATE.activeMissionCompleted;
    let previousMissionKey = DEFAULT_STATE.previousMissionKey;
    let cEmo = DEFAULT_STATE.cEmo.slice(); 

    // --- Ba≈ülangƒ±√ß Fonksiyonlarƒ± ---
    window.onload = function() {
        ['mainMenu', 'gameScreen', 'scores', 'pot', 'status', 'gameOver', 'newGameBtn', 'history', 'settingsModalContent', 'temaSecim', 'inventoryBtn', 'missionBtn', 'inventoryModal', 'inventoryContainer', 'missionModal', 'missionContainer', 'maxScoreDisplay'].forEach(id => d[id] = document.getElementById(id)); 
        d.btns = [document.getElementById('btnC'), document.getElementById('btnA'), document.getElementById('btnY')];

        // Emojileri ve G√∂revi Atama (Sadece ilk y√ºklemede bir kere)
        setupNewGameEmojis(); 
        assignRandomMission(); 
        
        temaSec('beyaz', true);
        guncelle(); 
    };

    function uyar(msg) { alert(msg) }
    function rasgele() { return ['A', '√á', 'Y'][Math.floor(Math.random() * 3)] }
    function setupNewGameEmojis() { 
        const shuffled = DYN_EMO.sort(() => .5 - Math.random()); 
        cEmo[1] = shuffled[0]; 
        cEmo[2] = shuffled[1];
    }
    
    function toggleModal(id, ac) { 
        const modal = document.getElementById(id); 
        modal.style.display = ac ? 'flex' : 'none'; 
        if(ac) guncelle();
    }

    function toggleInventory(ac) {
        if (ac) { 
            d.inventoryModal.querySelector('h2').innerHTML = `üéí Envanter (Jeton: ${ITEMS.jeton.list.length})`;
            renderInventory(); 
            d.inventoryModal.classList.add('active'); 
            d.inventoryModal.style.display = 'flex'; 
        } 
        else { 
            d.inventoryModal.classList.remove('active'); 
            setTimeout(() => { d.inventoryModal.style.display = 'none'; }, 400); 
        }
    }

    function resetCurrentGameState() {
        p = DEFAULT_STATE.p.slice(); 
        pot = DEFAULT_STATE.pot; 
        bitis = false; 
        hamleler = DEFAULT_STATE.hamleler.map(arr => arr.slice()); 
        cooldown = false; 
        setupNewGameEmojis(); // Yeni YZ emojilerini ayarla
        
        // G√∂rev ilerlemesini sƒ±fƒ±rla
        resetMissionProgress(activeMissionKey);
        
        d.history.innerHTML = ""; 
        d.gameOver.innerText = ""; 
        d.newGameBtn.style.display = "none"; 
        d.btns.forEach(btn => btn.disabled = false); 
        d.status.innerText = "Hamleni se√ß";
    }

    // Oyun bittikten sonra men√ºye d√∂n√º≈ü√º ve sƒ±fƒ±rlamayƒ± y√∂neten fonksiyon
    function resetToMenu() {
        // Oyun durumunu sƒ±fƒ±rla (bu aynƒ± zamanda g√∂rev ilerlemesini de sƒ±fƒ±rlar)
        resetCurrentGameState();
        
        // Oyun ekranƒ±nƒ± gizle, men√ºy√º g√∂ster
        d.gameScreen.style.display = 'none'; 
        d.inventoryBtn.style.display = 'none'; 
        d.missionBtn.style.display = 'none'; 
        d.maxScoreDisplay.style.display = 'none'; 
        d.mainMenu.style.display = 'flex'; 
        
        guncelle();
    }

    function startGame(max_skor, kazan_jeton) {
        // Oyun uzunluƒüunu ve Jeton √∂d√ºl√ºn√º ayarla
        MAX_SKOR = max_skor; 
        KAZANC_JETON = kazan_jeton;
        
        // Oyun ayarlarƒ±nƒ± sƒ±fƒ±rla
        resetCurrentGameState();
        
        // Aray√ºz√º g√ºncelle ve men√ºy√º gizle, oyunu ba≈ülat
        d.mainMenu.style.display = 'none'; 
        d.gameScreen.style.display = 'flex'; 
        d.inventoryBtn.style.display = 'flex'; 
        d.missionBtn.style.display = 'flex'; 
        d.maxScoreDisplay.style.display = 'block'; 
        d.maxScoreDisplay.innerText = `${MAX_SKOR}`; 
        
        guncelle()
    }

    // --- Oyun Mantƒ±ƒüƒ± ---

    function oyuncu(h) {
        if (bitis || cooldown) return; cooldown = true; d.btns.forEach(btn => btn.disabled = true);
        const mv = [h, rasgele(), rasgele()]; turSonucu(mv);
        let sayac = 3; d.status.innerText = `(${sayac})`;
        const interval = setInterval(() => {
            sayac--;
            if (sayac > 0) { d.status.innerText = `(${sayac})` }
            else { 
                clearInterval(interval); 
                cooldown = false; 
                d.btns.forEach(btn => btn.disabled = bitis); 
                d.status.innerText = bitis ? "Oyun Bitti" : "Hamleni se√ß";
            }
        }, 1000)
    }

    function turSonucu(mv) {
        const onceki = pot; const A = mv.filter(x => x === 'A').length; const C = mv.filter(x => x === '√á').length; const Y = mv.filter(x => x === 'Y').length;
        let kazanc = [0, 0, 0]; let paylasildi = false; let aciklama = [];
        
        if (A === 0) { pot += 6; aciklama.push("Birikti.") }
        else if (C > 0 && Y > 0) { const pay = onceki / Y; mv.forEach((m, i) => { if (m === 'Y') kazanc[i] = pay }); paylasildi = true; aciklama.push("Yakalayanlar kazandƒ±.") }
        else if (C > 0) { const calanlar = mv.map((m, i) => m === '√á' ? i : -1).filter(i => i !== -1); const pay = onceki / C; calanlar.forEach(i => kazanc[i] = pay); paylasildi = true; aciklama.push(calanlar.length === 1 ? "Para √áalƒ±ndƒ±." : "√áalanlar b√∂l√º≈üt√º.") }
        else if (A > 0) { const pay = onceki / A; mv.forEach((m, i) => { if (m === 'A') kazanc[i] = pay }); paylasildi = true; aciklama.push("Alƒ±cƒ±lar b√∂l√º≈üt√º.") }

        if (paylasildi) { 
            for (let i = 0; i < 3; i++) p[i] += kazanc[i]; 
            pot = 6 
        }

        let bonusAciklama = ""; 
        let userCayBonus = false; 
        
        for (let i = 0; i < 3; i++) { 
            hamleler[i].push(mv[i]); 
            if (hamleler[i].slice(-3).join('') === '√áAY') { 
                p[i] += 4; bonusAciklama += ` ${cEmo[i]} (+4 Bonus)!`;
                if (i === 0) userCayBonus = true; 
            }
        }
        
        // G√ñREV ƒ∞LERLEMESƒ∞ KONTROL√ú
        if (!activeMissionCompleted && activeMissionKey) {
            const m = MISSIONS[activeMissionKey];
            
            if (activeMissionKey === 'bonus_cay_x2' && userCayBonus) {
                if (typeof m.progress === 'number') m.progress++;
            }
            else if (activeMissionKey === 'caca√ßa' && hamleler[0].length >= 6 && hamleler[0].slice(-6).join('') === '√áA√áA√áA') {
                m.progress = m.required;
            }
            else if (activeMissionKey === 'big_win' && kazanc[0] >= 15) {
                m.progress = true;
            }
            
            checkMissionComplete();
        }

        const kazancStr = kazanc.map(x => Math.floor(x)).join(', ');
        const s = `${cEmo[0]}:${mv[0]} | ${cEmo[1]}:${mv[1]} | ${cEmo[2]}:${mv[2]} ‚Üí +${kazancStr} | ${aciklama.join(' ')}${bonusAciklama}`;

        d.history.innerHTML += s + "<br>"; d.history.scrollTop = d.history.scrollHeight;
        
        guncelle(); kontrol()
    }
    
    function kontrol() {
        if (bitis) return; const mx = Math.max(...p);
        
        // G√∂rev Kontrolleri (Oyun Sonu Gerektirenler)
        if (!activeMissionCompleted && activeMissionKey) {
            const m = MISSIONS[activeMissionKey];
            
            if (activeMissionKey === 'defeat_smiley' && (cEmo[1] === '‚òªÔ∏è' || cEmo[2] === '‚òªÔ∏è')) {
                const smileyIndex = cEmo.indexOf('‚òªÔ∏è');
                if (p[0] >= MAX_SKOR && Math.floor(p[smileyIndex]) < MAX_SKOR) m.progress = true; 
            }
            
            if (activeMissionKey === 'no_c_game' && p[0] >= MAX_SKOR) {
                const otherWinners = p.slice(1).some(score => Math.floor(score) >= MAX_SKOR);
                if (!otherWinners && !hamleler[0].includes('√á')) {
                    m.progress = true; 
                }
            }
            
            checkMissionComplete();
        }

        if (mx >= MAX_SKOR) {
            bitis = true; d.btns.forEach(btn => btn.disabled = true);
            
            if (p[0] >= MAX_SKOR) { 
                for(let i=0; i<KAZANC_JETON; i++) ITEMS.jeton.list.push({ uniqueId: nextUniqueId++ });
            }
            
            const kazananlar = p.map((P, i) => Math.floor(P) >= MAX_SKOR ? ADLAR[i] : null).filter(Boolean).join(', ');
            // Butonun yeni i≈ülevi "Yeni Oyun" yerine "Men√ºye D√∂n" mantƒ±ƒüƒ±dƒ±r.
            d.gameOver.innerText = `üèÅ Oyun Bitti ‚Äî Kazanan: ${kazananlar}${p[0] >= MAX_SKOR ? ` (+${KAZANC_JETON} Jeton)` : ""}`;
            d.newGameBtn.style.display = "inline-block"; d.status.innerText = "Oyun Bitti";
        }
    }

    // --- G√∂rev Mantƒ±ƒüƒ± ---

    function assignRandomMission() {
        const missionKeys = Object.keys(MISSIONS);
        let newMissionKey;
        let attempts = 0;
        
        do {
            const randomIndex = Math.floor(Math.random() * missionKeys.length);
            newMissionKey = missionKeys[randomIndex];
            attempts++;
            if (attempts > 10) break; 
        } while (newMissionKey === activeMissionKey); 

        previousMissionKey = activeMissionKey; 
        activeMissionKey = newMissionKey;
        activeMissionCompleted = false; 
        d.missionBtn.setAttribute('data-status-icon', ''); 
        guncelle(); 
    }
    
    function collectRewardAndAssignNew() {
        if (!activeMissionCompleted) return;

        for(let i=0; i<MISSION_REWARD; i++) ITEMS.jeton.list.push({ uniqueId: nextUniqueId++ });

        d.gameOver.innerText = ""; d.gameOver.className = "";
        
        resetMissionProgress(activeMissionKey); 
        assignRandomMission(); 
        
        toggleModal('missionModal', false);
        
        uyar(`+${MISSION_REWARD} Jeton Envantere Eklendi! Yeni G√∂rev Atandƒ±.`);
        guncelle(); 
    }

    function resetMissionProgress(key) {
        if (!key) return;
        
        MISSIONS['bonus_cay_x2'].progress = 0;
        MISSIONS['no_c_game'].progress = false;
        MISSIONS['defeat_smiley'].progress = false;
        MISSIONS['caca√ßa'].progress = 0;
        MISSIONS['big_win'].progress = false;
        
        const mission = MISSIONS[key];
        if (typeof mission.progress === 'number') {
            mission.progress = 0;
        } else {
            mission.progress = false;
        }
        activeMissionCompleted = false; 
        d.missionBtn.setAttribute('data-status-icon', ''); 
    }
    
    function checkMissionComplete() {
        if (activeMissionCompleted || !activeMissionKey) return;
        
        const mission = MISSIONS[activeMissionKey];
        let completed = false;
        
        if (typeof mission.progress === 'number' && mission.progress >= mission.required) completed = true;
        else if (typeof mission.progress === 'boolean' && mission.progress === true) completed = true;
        
        if (completed) {
            activeMissionCompleted = true; 
            d.missionBtn.setAttribute('data-status-icon', '‚úÖ');
            d.gameOver.innerText = `G√ñREV TAMAMLANDI: ${mission.name} (√ñd√ºl Hazƒ±r!)`;
            d.gameOver.className = "kupa-mesaji";
            guncelle(); 
        }
    }

    function renderMissions() {
        const container = d.missionContainer;
        
        if (!activeMissionKey) {
             container.innerHTML = `<div class="mission-info-box"><strong>Aktif G√∂rev Yok.</strong> Yeni oyun ba≈ülatƒ±ldƒ±ƒüƒ±nda atanacaktƒ±r.</div>`;
            toggleModal('missionModal', true);
            return;
        }

        const mission = MISSIONS[activeMissionKey];
        
        let progressInfo = '';
        if (typeof mission.progress === 'number') {
             progressInfo = `<p style="font-weight: bold; color: var(--blue); margin-top: 10px;">ƒ∞lerleme: ${mission.progress} / ${mission.required}</p>`;
        }
        
        let buttonHtml = '';
        if (activeMissionCompleted) {
            buttonHtml = `<button class="modal-action-btn" style="background:var(--green);" onclick="collectRewardAndAssignNew()">√ñd√ºl√º Topla (${MISSION_REWARD} ü™ô)</button>`;
        } 
        
        container.innerHTML = `
            <div class="mission-info-box">
                <h3 style="color: var(--text); margin-bottom: 5px;">${mission.name}</h3>
                ${progressInfo}
            </div>
            ${activeMissionCompleted ? 
                `<p style="font-weight: bold; color: var(--green); margin-bottom: 15px;">‚úÖ G√ñREV TAMAMLANDI! √ñd√ºl Toplamaya Hazƒ±r.</p>` : 
                `<p style="font-size: 14px; margin-top: 15px; text-align: center; color: var(--text);">Oynamaya devam edin. G√∂rev tamamlandƒ±ƒüƒ±nda buton √ºzerinde ‚úÖ g√∂receksiniz.</p>`
            }
            ${buttonHtml}
        `;
        
        toggleModal('missionModal', true); 
    }

    // --- Envanter ve Birle≈ütirme Mantƒ±ƒüƒ± ---
    function renderInventory() {
        d.inventoryContainer.innerHTML = '';
        
        // T√ºm √∂ƒüeleri (Jetonlar dahil) aynƒ± d√∂ng√º i√ßinde render et.
        Object.keys(ITEMS).forEach(itemId => {
            const item = ITEMS[itemId];
            
            if (itemId === 'masterRozet' && item.list.length > 0) {
                if (!bitis) {
                    bitis = true; d.btns.forEach(btn => btn.disabled = true); d.status.innerText = "Oyun Bitti (Rozet Tamamlandƒ±)";
                    d.gameOver.innerText = `üèÖ ${item.name} Tamamlandƒ±! TEBRƒ∞KLER! üèÖ`; d.gameOver.className = "kupa-mesaji"; d.newGameBtn.style.display = "inline-block";
                }
            }

            item.list.forEach(uniqueItem => {
                const div = document.createElement('div');
                div.className = 'inventory-item'; div.id = `${itemId}-${uniqueItem.uniqueId}`;
                div.setAttribute('data-item', itemId); div.setAttribute('data-unique-id', uniqueItem.uniqueId); 
                const canDrag = itemId !== 'masterRozet'; div.setAttribute('data-can-drag', canDrag ? 'true' : 'false'); div.draggable = canDrag;

                if (canDrag) {
                    ['dragstart', 'dragover', 'dragleave', 'drop', 'dragend'].forEach(e => div.addEventListener(e, eval(e)));
                }

                div.innerHTML = `<span>${item.emoji}</span>${item.name}`;
                d.inventoryContainer.appendChild(div);
            });
        });
    }

    // Drag-Merge Event Handlerlarƒ± (Kƒ±saltƒ±ldƒ±)
    function dragstart(e) {
        const itemId = e.target.getAttribute('data-item'); const uniqueId = e.target.getAttribute('data-unique-id');
        if (e.target.getAttribute('data-can-drag') === 'true') {
            draggedItemInfo = { itemId, uniqueId: parseInt(uniqueId) };
            const jsonData = JSON.stringify(draggedItemInfo);
            e.dataTransfer.setData('text/plain', jsonData); e.dataTransfer.setData('application/json', jsonData);
            e.target.classList.add('dragging');
        } else { e.preventDefault(); }
    }
    function dragover(e) {
        e.preventDefault();
        const targetElement = e.currentTarget; const targetId = targetElement.getAttribute('data-item'); const targetUniqueId = parseInt(targetElement.getAttribute('data-unique-id'));
        if (!draggedItemInfo) return;
        if (draggedItemInfo.itemId === targetId && draggedItemInfo.uniqueId !== targetUniqueId && targetId !== 'masterRozet') targetElement.classList.add('drop-target');
        else targetElement.classList.remove('drop-target');
    }
    function dragleave(e) { e.currentTarget.classList.remove('drop-target'); }
    function drop(e) {
        e.preventDefault(); e.currentTarget.classList.remove('drop-target');
        let data = e.dataTransfer.getData('application/json') || e.dataTransfer.getData('text/plain'); if (!data) return; 
        let sourceInfo; try { sourceInfo = JSON.parse(data); } catch (error) { return; }
        const targetElement = e.currentTarget; const targetId = targetElement.getAttribute('data-item'); const targetUniqueId = parseInt(targetElement.getAttribute('data-unique-id'));

        if (sourceInfo.itemId !== targetId || sourceInfo.uniqueId === targetUniqueId) { return uyar("Ge√ßersiz Birle≈ütirme."); }
        
        handleMerge(sourceInfo.itemId, sourceInfo.uniqueId, targetUniqueId);
    }
    function dragend(e) { e.target.classList.remove('dragging'); draggedItemInfo = null; }

    function handleMerge(sourceId, id1, id2) {
        const sourceList = ITEMS[sourceId].list;
        
        const itemsToMerge = sourceList.filter(p => p.uniqueId === id1 || p.uniqueId === id2);
        if (itemsToMerge.length < BIRLESTIRME_PARCA_SAYISI) { return uyar(`Birle≈ütirmek i√ßin 2 adet ${ITEMS[sourceId].name} gerekiyor.`); }

        const mergeMap = { 'jeton': 'garnetParca', 'garnetParca': 'garnetKupa', 'garnetKupa': 'serpantinParca', 'serpantinParca': 'serpantinKupa', 'serpantinKupa': 'masterRozet' };
        const resultId = mergeMap[sourceId];
        
        if (!resultId || (resultId === 'masterRozet' && ITEMS[resultId].list.length > 0)) {
            return uyar(resultId ? `Zaten bir adet ${ITEMS[resultId].name} mevcut.` : "Bu √∂ƒüe birle≈ütirilemez.");
        }
        
        const resultName = ITEMS[resultId].name;
        // ƒ∞lgili ID'lere sahip √∂ƒüeleri listeden kaldƒ±r
        ITEMS[sourceId].list = sourceList.filter(p => p.uniqueId !== id1 && p.uniqueId !== id2);
        ITEMS[resultId].list.push({ uniqueId: nextUniqueId++ });

        d.gameOver.innerText = `üéâ Tebrikler! ${resultName} Elde Edildi!`; d.gameOver.className = "kupa-mesaji";

        if (resultId === 'masterRozet') { bitis = true; d.btns.forEach(btn => btn.disabled = true); d.status.innerText = "Oyun Bitti (Rozet Tamamlandƒ±)"; d.newGameBtn.style.display = "inline-block"; } 
        else { setTimeout(() => { d.gameOver.innerText = ""; d.gameOver.className = ""; if(!bitis) d.status.innerText = "Hamleni se√ß"; }, 5000); }

        guncelle(); 
    }

    // **************** G√úNCELLEME VE TEMA ******************
    function guncelle() {
        d.scores.innerHTML = p.map((P, i) => `<div class="player-score"><span class="player-emoji">${cEmo[i]}</span>${Math.floor(P)}</div>`).join('');
        d.pot.innerText = `Ortadaki Para: ${Math.floor(pot)}`; 
        
        // Envanter ba≈ülƒ±ƒüƒ±nƒ± jeton sayƒ±sƒ±yla g√ºncelle
        if (d.inventoryModal.querySelector('h2')) {
            d.inventoryModal.querySelector('h2').innerHTML = `üéí Envanter (Jeton: ${ITEMS.jeton.list.length})`;
        }
        
        if(d.maxScoreDisplay.style.display === 'block') d.maxScoreDisplay.innerText = `${MAX_SKOR}`;
        
        renderInventory();
        temaSec(aktifTema, true);
    }
    
    function temaSec(tema, initial = false) {
        aktifTema = tema;
        document.body.classList.remove('dark', 'retro');
        if (tema === 'siyah') document.body.classList.add('dark');
        else if (tema === 'retro') document.body.classList.add('retro');

        if (!initial) {
            guncelle();
        }

        document.querySelectorAll('#temaSecim button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${tema}TemaBtn`).classList.add('active');
    }
</script>
</body>
</html>